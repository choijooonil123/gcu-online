<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì˜¨ë¼ì¸ ê°•ì˜ì‹¤</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- PWA ì„¤ì • -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0f172a" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="GCU ê°•ì˜ì‹¤" />
  <link rel="icon" type="image/svg+xml" href="icons/icon.svg" />
  <link rel="apple-touch-icon" href="icons/icon.svg" />
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <style>
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        "Noto Sans KR", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
    }

    body {
      display: flex;
      flex-direction: column;
    }

    /* ========== ë¡œê·¸ì¸ í™”ë©´ ========== */
    .login-overlay {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .login-overlay.hidden {
      display: none;
    }

    .login-container {
      background: #020617;
      border: 1px solid #1f2937;
      border-radius: 16px;
      padding: 32px;
      width: 100%;
      max-width: 420px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }

    .login-header {
      text-align: center;
      margin-bottom: 28px;
    }

    .login-header h1 {
      font-size: 24px;
      margin: 0 0 8px 0;
      color: #f1f5f9;
    }

    .login-header p {
      font-size: 14px;
      color: #9ca3af;
      margin: 0;
    }

    .role-selector {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
    }

    .role-btn {
      flex: 1;
      padding: 16px 12px;
      border: 2px solid #374151;
      border-radius: 12px;
      background: transparent;
      color: #9ca3af;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .role-btn:hover {
      border-color: #4b5563;
      background: #1f2937;
    }

    .role-btn.active {
      border-color: #3b82f6;
      background: rgba(59, 130, 246, 0.1);
      color: #60a5fa;
    }

    .role-btn.active.admin {
      border-color: #8b5cf6;
      background: rgba(139, 92, 246, 0.1);
      color: #a78bfa;
    }

    .role-btn .role-icon {
      font-size: 28px;
    }

    .role-btn .role-label {
      font-size: 13px;
      font-weight: 600;
    }

    .form-group.hidden {
      display: none;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 6px;
      font-weight: 500;
    }

    .form-group input {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid #374151;
      border-radius: 8px;
      background: #0f172a;
      color: #e5e7eb;
      font-size: 14px;
      transition: border-color 0.2s ease;
    }

    .form-group input:focus {
      outline: none;
      border-color: #3b82f6;
    }

    .form-group input::placeholder {
      color: #6b7280;
    }

    .server-select {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid #374151;
      border-radius: 8px;
      background: #0f172a;
      color: #e5e7eb;
      font-size: 14px;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%239ca3af'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 16px;
    }

    .server-select:focus {
      outline: none;
      border-color: #3b82f6;
    }

    .server-select option {
      background: #1f2937;
      color: #e5e7eb;
    }

    .submit-btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 10px;
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: white;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.2s ease;
      margin-top: 8px;
    }

    .submit-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
    }

    .submit-btn:active {
      transform: translateY(0);
    }

    .login-footer {
      text-align: center;
      margin-top: 20px;
      font-size: 12px;
      color: #6b7280;
    }

    .school-name {
      font-size: 15px;
      font-weight: 600;
      background: linear-gradient(90deg, #60a5fa, #a78bfa, #f472b6, #60a5fa);
      background-size: 300% 100%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: sparkle 3s ease-in-out infinite;
    }

    @keyframes sparkle {
      0%, 100% {
        background-position: 0% 50%;
        filter: brightness(1);
      }
      50% {
        background-position: 100% 50%;
        filter: brightness(1.2);
      }
    }

    /* ========== ë©”ì¸ ë ˆì´ì•„ì›ƒ ========== */
    .main-app {
      display: none;
      flex-direction: column;
      height: 100%;
    }

    .main-app.show {
      display: flex;
    }

    header {
      padding: 10px 16px;
      background: #020617;
      border-bottom: 1px solid #1f2937;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    header .title {
      font-size: 18px;
      font-weight: 600;
    }

    header .subtitle {
      font-size: 12px;
      color: #9ca3af;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: #1f2937;
      border-radius: 8px;
      font-size: 13px;
    }

    .user-badge.professor {
      border: 1px solid #f59e0b;
      color: #fcd34d;
    }

    .user-badge.student {
      border: 1px solid #10b981;
      color: #6ee7b7;
    }

    .user-badge .badge-icon {
      font-size: 16px;
    }

    .logout-btn {
      padding: 6px 12px;
      border: 1px solid #ef4444;
      border-radius: 6px;
      background: transparent;
      color: #f87171;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .logout-btn:hover {
      background: rgba(239, 68, 68, 0.1);
    }

    main {
      flex: 1;
      display: flex;
      padding: 8px;
      height: calc(100% - 56px);
    }

    section {
      flex: 1;
      width: 100%;
      background: #020617;
      border-radius: 10px;
      border: 1px solid #1f2937;
      padding: 10px;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .jitsi-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      position: relative;
    }

    .jitsi-header {
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .room-name-display {
      font-weight: 500;
      color: #60a5fa;
    }

    .jitsi-frame {
      flex: 1;
      border: none;
      border-radius: 8px;
      background: black;
      width: 100%;
    }

    .small-note {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
    }

    @media (max-width: 900px) {
      .user-info {
        width: 100%;
        justify-content: space-between;
      }
    }

    /* ========== PWA ì„¤ì¹˜ ë²„íŠ¼ ========== */
    .install-btn {
      display: none;
      width: 100%;
      padding: 12px;
      margin-top: 12px;
      border: 2px dashed #10b981;
      border-radius: 10px;
      background: rgba(16, 185, 129, 0.1);
      color: #6ee7b7;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .install-btn:hover {
      background: rgba(16, 185, 129, 0.2);
      border-style: solid;
    }

    .install-btn.show {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .install-guide {
      display: none;
      margin-top: 12px;
      padding: 12px;
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid #3b82f6;
      border-radius: 8px;
      font-size: 12px;
      color: #93c5fd;
      text-align: center;
    }

    .install-guide.show {
      display: block;
    }

    /* ========== êµìˆ˜ ì»¨íŠ¸ë¡¤ ë°” ========== */
    .professor-controls {
      display: none;
      gap: 8px;
      padding: 10px;
      background: #020617;
      border-bottom: 1px solid #1f2937;
      flex-wrap: wrap;
    }

    .professor-controls.show {
      display: flex;
    }

    /* ========== í—¤ë” ë²„íŠ¼ (êµìˆ˜/í•™ìƒ) ========== */
    .professor-header-btns,
    .student-header-btns {
      display: none;
      gap: 6px;
      align-items: center;
    }

    .professor-header-btns.show,
    .student-header-btns.show {
      display: flex;
    }

    .header-btn {
      padding: 6px 10px;
      border: 1px solid #374151;
      border-radius: 6px;
      background: #1f2937;
      color: #e5e7eb;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    .header-btn:hover {
      background: #374151;
    }

    .header-btn.primary {
      background: #2563eb;
      border-color: #2563eb;
      color: white;
    }

    .header-btn.primary:hover {
      background: #1d4ed8;
    }

    .header-btn.primary:disabled {
      background: #374151;
      border-color: #374151;
      color: #6b7280;
      cursor: not-allowed;
    }

    .header-btn.danger {
      background: #dc2626;
      border-color: #dc2626;
      color: white;
    }

    .header-btn.danger:hover {
      background: #b91c1c;
    }

    .header-btn.danger:disabled {
      background: #374151;
      border-color: #374151;
      color: #6b7280;
      cursor: not-allowed;
    }

    .header-btn.success {
      background: #16a34a;
      border-color: #16a34a;
      color: white;
    }

    .header-btn.success:hover {
      background: #15803d;
    }

    .header-btn.success:disabled {
      background: #374151;
      border-color: #374151;
      color: #6b7280;
      cursor: not-allowed;
    }

    .header-status {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: rgba(15, 23, 42, 0.8);
      border-radius: 6px;
      font-size: 12px;
      color: #9ca3af;
    }

    .ctrl-btn {
      padding: 8px 16px;
      border: 1px solid #374151;
      border-radius: 8px;
      background: #1f2937;
      color: #e5e7eb;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .ctrl-btn:hover {
      background: #374151;
    }

    .ctrl-btn.primary {
      background: #2563eb;
      border-color: #2563eb;
      color: white;
    }

    .ctrl-btn.primary:hover {
      background: #1d4ed8;
    }

    .ctrl-btn.danger {
      background: #dc2626;
      border-color: #dc2626;
      color: white;
    }

    .ctrl-btn.danger:hover {
      background: #b91c1c;
    }

    .ctrl-btn.success {
      background: #16a34a;
      border-color: #16a34a;
      color: white;
    }

    .ctrl-btn.success:hover {
      background: #15803d;
    }

    .ctrl-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .class-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: #0f172a;
      border-radius: 8px;
      font-size: 13px;
      margin-left: auto;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #6b7280;
    }

    .status-dot.live {
      background: #22c55e;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* ========== ëª¨ë‹¬ ========== */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 20px;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal {
      background: #0f172a;
      border: 1px solid #1f2937;
      border-radius: 16px;
      width: 100%;
      max-width: 800px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid #1f2937;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 18px;
      color: #f1f5f9;
    }

    .modal-close {
      background: none;
      border: none;
      color: #9ca3af;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }

    .modal-close:hover {
      color: #f1f5f9;
    }

    .modal-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }

    .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid #1f2937;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    /* ========== ìˆ˜ê°•ìƒ ê´€ë¦¬ ========== */
    .student-input-row {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
    }

    .student-input-row input {
      flex: 1;
      padding: 10px 14px;
      border: 1px solid #374151;
      border-radius: 8px;
      background: #020617;
      color: #e5e7eb;
      font-size: 14px;
    }

    .student-input-row input:focus {
      outline: none;
      border-color: #3b82f6;
    }

    .student-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .student-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      background: #1f2937;
      border-radius: 8px;
    }

    .student-item .student-name {
      font-size: 14px;
    }

    .student-item .delete-btn {
      background: none;
      border: none;
      color: #ef4444;
      cursor: pointer;
      font-size: 18px;
      padding: 0;
    }

    .student-item .delete-btn:hover {
      color: #f87171;
    }

    .empty-list {
      text-align: center;
      color: #6b7280;
      padding: 30px;
      font-size: 14px;
    }

    /* ========== ì¶œì„ë¶€ í…Œì´ë¸” ========== */
    .week-selector {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 16px;
    }

    .week-selector label {
      font-size: 14px;
      color: #9ca3af;
    }

    .week-selector select {
      padding: 8px 12px;
      border: 1px solid #374151;
      border-radius: 8px;
      background: #020617;
      color: #e5e7eb;
      font-size: 14px;
    }

    .attendance-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .attendance-table th,
    .attendance-table td {
      padding: 10px 12px;
      text-align: left;
      border-bottom: 1px solid #1f2937;
    }

    .attendance-table th {
      background: #020617;
      color: #9ca3af;
      font-weight: 600;
    }

    .attendance-table tr:hover {
      background: rgba(59, 130, 246, 0.05);
    }

    .attendance-status {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .attendance-status.present {
      background: rgba(34, 197, 94, 0.2);
      color: #4ade80;
    }

    .attendance-status.late {
      background: rgba(251, 191, 36, 0.2);
      color: #fbbf24;
    }

    .attendance-status.early-leave {
      background: rgba(249, 115, 22, 0.2);
      color: #fb923c;
    }

    .attendance-status.absent {
      background: rgba(239, 68, 68, 0.2);
      color: #f87171;
    }

    .attendance-status.pending {
      background: rgba(107, 114, 128, 0.2);
      color: #9ca3af;
    }

    .time-info {
      font-size: 11px;
      color: #6b7280;
    }

    .attendance-summary {
      display: flex;
      gap: 16px;
      margin-top: 16px;
      padding: 12px;
      background: #020617;
      border-radius: 8px;
      flex-wrap: wrap;
    }

    .summary-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
    }

    .summary-item .count {
      font-weight: 700;
    }

    /* ========== ìš´ì˜ì ë°°ì§€ ========== */
    .user-badge.admin {
      border: 1px solid #8b5cf6;
      color: #c4b5fd;
    }

    /* ========== ìš´ì˜ì ì»¨íŠ¸ë¡¤ ë°” ========== */
    .admin-controls {
      display: none;
      gap: 8px;
      padding: 10px;
      background: #020617;
      border-bottom: 1px solid #1f2937;
      flex-wrap: wrap;
    }

    .admin-controls.show {
      display: flex;
    }

    /* ========== ê°•ì˜ ê´€ë¦¬ ========== */
    .course-card {
      background: #1f2937;
      border: 1px solid #374151;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
    }

    .course-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .course-card-title {
      font-size: 16px;
      font-weight: 600;
      color: #f1f5f9;
    }

    .course-card-info {
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 13px;
      color: #9ca3af;
    }

    .course-card-info span {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .course-card-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .admin-form-group {
      margin-bottom: 16px;
    }

    .admin-form-group label {
      display: block;
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 6px;
      font-weight: 500;
    }

    .admin-form-group input,
    .admin-form-group textarea {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid #374151;
      border-radius: 8px;
      background: #020617;
      color: #e5e7eb;
      font-size: 14px;
    }

    .admin-form-group textarea {
      min-height: 120px;
      resize: vertical;
      font-family: inherit;
    }

    .admin-form-group input:focus,
    .admin-form-group textarea:focus {
      outline: none;
      border-color: #8b5cf6;
    }

    .admin-form-group .help-text {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
    }

    .no-courses {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }

    /* ========== ì „ì²´ ì¶œì„ë¶€ ========== */
    .all-attendance-filters {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
      align-items: center;
    }

    .all-attendance-filters select {
      padding: 8px 12px;
      border: 1px solid #374151;
      border-radius: 8px;
      background: #020617;
      color: #e5e7eb;
      font-size: 14px;
    }

    .course-attendance-section {
      background: #1e293b;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .course-attendance-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid #374151;
    }

    .course-attendance-title {
      font-size: 16px;
      font-weight: 600;
      color: #f1f5f9;
    }

    .course-attendance-meta {
      font-size: 12px;
      color: #9ca3af;
    }

    .week-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .week-tab {
      padding: 6px 12px;
      border: 1px solid #374151;
      border-radius: 6px;
      background: transparent;
      color: #9ca3af;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .week-tab:hover {
      background: #374151;
    }

    .week-tab.active {
      background: #3b82f6;
      border-color: #3b82f6;
      color: white;
    }

    .week-tab.has-data {
      border-color: #22c55e;
      color: #4ade80;
    }

    .week-tab.has-data.active {
      background: #16a34a;
      border-color: #16a34a;
      color: white;
    }

    .mini-attendance-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .mini-attendance-table th,
    .mini-attendance-table td {
      padding: 8px 10px;
      text-align: left;
      border-bottom: 1px solid #374151;
    }

    .mini-attendance-table th {
      background: #0f172a;
      color: #9ca3af;
      font-weight: 600;
    }

    .mini-attendance-table tr:hover {
      background: rgba(59, 130, 246, 0.05);
    }

    .export-all-btn {
      margin-left: auto;
    }
  </style>
</head>
<body>

  <!-- ========== ë¡œê·¸ì¸ í™”ë©´ ========== -->
  <div class="login-overlay" id="loginOverlay">
    <div class="login-container">
      <div class="login-header">
        <h1>ğŸ“ ì˜¨ë¼ì¸ ê°•ì˜ì‹¤ ğŸ“</h1>
    </div>

      <!-- ì—­í•  ì„ íƒ -->
      <div class="role-selector">
        <button type="button" class="role-btn" id="btnAdmin" onclick="selectRole('admin')">
          <span class="role-icon">âš™ï¸</span>
          <span class="role-label">ìš´ì˜</span>
        </button>
        <button type="button" class="role-btn" id="btnProfessor" onclick="selectRole('professor')">
          <span class="role-icon">ğŸ‘¨â€ğŸ«</span>
          <span class="role-label">êµìˆ˜</span>
        </button>
        <button type="button" class="role-btn active" id="btnStudent" onclick="selectRole('student')">
          <span class="role-icon">ğŸ‘¨â€ğŸ“</span>
          <span class="role-label">í•™ìƒ</span>
        </button>
      </div>

      <!-- ì…ë ¥ í¼ -->
      <form id="loginForm" onsubmit="handleLogin(event)">
        <div class="form-group">
          <label for="inputName" id="labelName">ì´ë¦„ *</label>
          <input type="text" id="inputName" placeholder="í™ê¸¸ë™" required />
        </div>

        <div class="form-group hidden" id="groupEmployeeId">
          <label for="inputEmployeeId" id="labelEmployeeId">ì‚¬ë²ˆ *</label>
          <input type="password" id="inputEmployeeId" placeholder="ì‚¬ë²ˆ ì…ë ¥" />
        </div>

        <div class="form-group" id="groupCourse">
          <label for="inputCourse">ê°•ì˜ëª… *</label>
          <input type="text" id="inputCourse" placeholder="ì˜ˆ: ì„±ê²½ê°œë¡ " required />
        </div>

        <div class="form-group" style="display:none;">
          <label for="serverSelect">ì„œë²„ ì„ íƒ</label>
          <select id="serverSelect" class="server-select">
            <option value="https://meet.ffmuc.net">ë…ì¼ ì„œë²„ (meet.ffmuc.net)</option>
            <option value="https://meet.jit.si">Jitsi ê¸°ë³¸ (meet.jit.si)</option>
            <option value="https://jitsi.riot.im">Riot ì„œë²„ (jitsi.riot.im)</option>
            <option value="https://meet.scheible.it">Scheible ì„œë²„ (meet.scheible.it)</option>
          </select>
        </div>

        <button type="submit" class="submit-btn" id="submitBtn">
          ğŸš€ ê°•ì˜ì‹¤ ì…ì¥
        </button>
    </form>

      <!-- PWA ì„¤ì¹˜ ë²„íŠ¼ -->
      <button type="button" class="install-btn" id="installBtn" onclick="installApp()">
        ğŸ“² í™ˆ í™”ë©´ì— ì•± ì¶”ê°€
      </button>
      
      <!-- iOS ì„¤ì¹˜ ê°€ì´ë“œ -->
      <div class="install-guide" id="iosGuide">
        ğŸ“± iPhone/iPad: í•˜ë‹¨ì˜ <b>ê³µìœ  ë²„íŠ¼</b> â†’ <b>"í™ˆ í™”ë©´ì— ì¶”ê°€"</b>ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”
      </div>

      <div class="login-footer">
        <span class="school-name">ê¹€ì²œëŒ€í•™êµ ìƒë‹´ì‹¬ë¦¬í•™ê³¼</span>
        <div id="firebaseStatus" style="margin-top: 8px; font-size: 11px;"></div>
      </div>
    </div>
      </div>

  <!-- ========== ë©”ì¸ ì•± ========== -->
  <div class="main-app" id="mainApp">
    <header>
      <div class="header-left">
        <div class="title"><span class="school-name">ê¹€ì²œëŒ€í•™êµ ìƒë‹´ì‹¬ë¦¬í•™ê³¼</span> ê°•ì˜ì‹¤</div>
      </div>

      <div class="user-info">
        <!-- êµìˆ˜ ì „ìš© ë²„íŠ¼ (ë°°ì§€ ì™¼ìª½) -->
        <div class="professor-header-btns" id="professorHeaderBtns">
          <button class="header-btn primary" id="btnStartClass" onclick="startClass()">â–¶ï¸ ìˆ˜ì—…ì‹œì‘</button>
          <button class="header-btn danger" id="btnEndClass" onclick="endClass()" disabled>â¹ï¸ ìˆ˜ì—…ì¢…ë£Œ</button>
          <button class="header-btn" onclick="openAttendanceModal()">ğŸ“‹ ì¶œì„ë¶€</button>
          <span class="header-status" id="headerClassStatus">
            <span class="status-dot" id="statusDot"></span>
            <span id="classStatusText">ìˆ˜ì—… ëŒ€ê¸°ì¤‘</span>
          </span>
      </div>
        <!-- í•™ìƒ ì „ìš© ë²„íŠ¼ (ë°°ì§€ ì™¼ìª½) -->
        <div class="student-header-btns" id="studentHeaderBtns">
          <button class="header-btn" onclick="openMyAttendanceModal()">ğŸ“‹ ë‚´ ì¶œì„í˜„í™©</button>
          <button class="header-btn success" id="btnCheckIn" onclick="studentCheckIn()">âœ‹ ì¶œì„í•˜ê¸°</button>
        </div>
        <div class="user-badge" id="userBadge">
          <span class="badge-icon" id="badgeIcon">ğŸ‘¨â€ğŸ«</span>
          <span id="badgeText">CHOI JUNIL êµìˆ˜</span>
        </div>
        <button class="logout-btn" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </header>

    <!-- ìš´ì˜ì ì „ìš© ì»¨íŠ¸ë¡¤ ë°” -->
    <div class="admin-controls" id="adminControls">
      <button class="ctrl-btn primary" onclick="openCourseModal()">
        ğŸ“š ê°•ì˜ ê´€ë¦¬
      </button>
      <button class="ctrl-btn" onclick="openAllAttendanceModal()">
        ğŸ“‹ ì „ì²´ ì¶œì„ë¶€
      </button>
      <button class="ctrl-btn" onclick="checkFirebaseStatus()" style="margin-left:auto;">
        ğŸ” Firebase ì§„ë‹¨
      </button>
    </div>

    <main>
      <!-- Jitsi ì˜ìƒì˜ì—­ -->
    <section>
      <div class="jitsi-wrapper">
        <div class="jitsi-header">
          <div>
              í˜„ì¬ ê°•ì˜ëª…: <span class="room-name-display" id="roomNameDisplay">-</span>
              <span id="serverStatus" style="margin-left: 12px; font-size: 12px; color: #60a5fa;"></span>
          </div>
          <div class="small-note">
            ì²˜ìŒ ì ‘ì† ì‹œ ë¸Œë¼ìš°ì €ê°€ ì¹´ë©”ë¼/ë§ˆì´í¬ ê¶Œí•œì„ ìš”ì²­í•˜ë©´ <b>í—ˆìš©</b>ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
          </div>
        </div>

        <!-- ë¡œë”©/ë””ë²„ê·¸ í‘œì‹œ -->
        <div id="jitsiLoading" style="display:none; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); text-align:center; color:#9ca3af; z-index:10;">
          <div style="width:50px; height:50px; border:4px solid #374151; border-top:4px solid #60a5fa; border-radius:50%; margin:0 auto 20px; animation:spin 1s linear infinite;"></div>
          <p>ê°•ì˜ì‹¤ì— ì ‘ì† ì¤‘ì…ë‹ˆë‹¤...</p>
          <p id="debugInfo" style="font-size:11px; margin-top:10px; color:#6b7280;"></p>
        </div>
        <style>@keyframes spin { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }</style>

        <!-- Jitsi IFrame -->
        <iframe
          id="jitsiFrame"
          class="jitsi-frame"
          allow="camera; microphone; fullscreen; display-capture"
          src=""
          onload="onJitsiLoaded()"
        ></iframe>
      </div>
    </section>
  </main>
  </div>

  <!-- ========== ìˆ˜ê°•ìƒ ê´€ë¦¬ ëª¨ë‹¬ ========== -->
  <div class="modal-overlay" id="studentModal">
    <div class="modal">
      <div class="modal-header">
        <h2>ğŸ‘¥ ìˆ˜ê°•ìƒ ê´€ë¦¬</h2>
        <button class="modal-close" onclick="closeStudentModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="student-input-row">
          <input type="text" id="newStudentName" placeholder="ìˆ˜ê°•ìƒ ì´ë¦„ ì…ë ¥" onkeypress="handleStudentKeypress(event)" />
          <button class="ctrl-btn primary" onclick="addStudent()">ì¶”ê°€</button>
        </div>
        <div class="student-list" id="studentList">
          <div class="empty-list">ë“±ë¡ëœ ìˆ˜ê°•ìƒì´ ì—†ìŠµë‹ˆë‹¤.</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="ctrl-btn" onclick="closeStudentModal()">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ========== ì¶œì„ë¶€ ëª¨ë‹¬ ========== -->
  <div class="modal-overlay" id="attendanceModal">
    <div class="modal" style="max-width: 900px;">
      <div class="modal-header">
        <h2>ğŸ“‹ ì¶œì„ë¶€</h2>
        <button class="modal-close" onclick="closeAttendanceModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="week-selector">
          <label>ì£¼ì°¨ ì„ íƒ:</label>
          <select id="weekSelect" onchange="renderAttendanceTable()">
            <option value="1">1ì£¼ì°¨</option>
            <option value="2">2ì£¼ì°¨</option>
            <option value="3">3ì£¼ì°¨</option>
            <option value="4">4ì£¼ì°¨</option>
            <option value="5">5ì£¼ì°¨</option>
            <option value="6">6ì£¼ì°¨</option>
            <option value="7">7ì£¼ì°¨</option>
            <option value="8">8ì£¼ì°¨</option>
            <option value="9">9ì£¼ì°¨</option>
            <option value="10">10ì£¼ì°¨</option>
            <option value="11">11ì£¼ì°¨</option>
            <option value="12">12ì£¼ì°¨</option>
            <option value="13">13ì£¼ì°¨</option>
            <option value="14">14ì£¼ì°¨</option>
            <option value="15">15ì£¼ì°¨</option>
            <option value="16">16ì£¼ì°¨</option>
          </select>
          <button class="ctrl-btn" onclick="exportAttendance()">ğŸ“¥ ë‚´ë³´ë‚´ê¸°</button>
        </div>
        <table class="attendance-table">
          <thead>
            <tr>
              <th>ë²ˆí˜¸</th>
              <th>ì´ë¦„</th>
              <th>ì…ì¥ì‹œê°„</th>
              <th>í‡´ì¥ì‹œê°„</th>
              <th>ì¶œì„ìƒíƒœ</th>
            </tr>
          </thead>
          <tbody id="attendanceTableBody">
          </tbody>
        </table>
        <div class="attendance-summary" id="attendanceSummary">
        </div>
      </div>
      <div class="modal-footer">
        <button class="ctrl-btn" onclick="closeAttendanceModal()">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ========== ê°•ì˜ ê´€ë¦¬ ëª¨ë‹¬ (ìš´ì˜ììš©) ========== -->
  <div class="modal-overlay" id="courseModal">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h2>ğŸ“š ê°•ì˜ ê´€ë¦¬</h2>
        <button class="modal-close" onclick="closeCourseModal()">&times;</button>
      </div>
      <div class="modal-body">
        <!-- ê°•ì˜ ì¶”ê°€ í¼ -->
        <div style="background:#1e293b;padding:16px;border-radius:12px;margin-bottom:20px;">
          <h3 style="margin:0 0 16px 0;font-size:15px;color:#f1f5f9;">â• ìƒˆ ê°•ì˜ ë“±ë¡</h3>
          <div class="admin-form-group">
            <label>ê°•ì˜ëª… *</label>
            <input type="text" id="newCourseName" placeholder="ì˜ˆ: ì„±ê²½ê°œë¡ " />
          </div>
          <div class="admin-form-group">
            <label>ë‹´ë‹¹êµìˆ˜ëª… *</label>
            <input type="text" id="newProfessorName" placeholder="ì˜ˆ: í™ê¸¸ë™" />
          </div>
          <div class="admin-form-group">
            <label>ìˆ˜ê°•ìƒ ëª…ë‹¨</label>
            <textarea id="newStudentList" placeholder="í•œ ì¤„ì— í•œ ëª…ì”© ì…ë ¥&#10;ì˜ˆ:&#10;ê¹€ì² ìˆ˜&#10;ì´ì˜í¬&#10;ë°•ë¯¼ìˆ˜"></textarea>
            <div class="help-text">í•œ ì¤„ì— í•œ ëª…ì”© ì…ë ¥í•´ì£¼ì„¸ìš”</div>
          </div>
          <button class="ctrl-btn success" onclick="addCourse()" style="width:100%;">ê°•ì˜ ë“±ë¡</button>
        </div>

        <!-- ë“±ë¡ëœ ê°•ì˜ ëª©ë¡ -->
        <h3 style="margin:0 0 12px 0;font-size:15px;color:#9ca3af;">ğŸ“‹ ë“±ë¡ëœ ê°•ì˜ ëª©ë¡</h3>
        <div id="courseList">
          <div class="no-courses">ë“±ë¡ëœ ê°•ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="ctrl-btn" onclick="closeCourseModal()">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ========== ê°•ì˜ ìˆ˜ì • ëª¨ë‹¬ ========== -->
  <div class="modal-overlay" id="editCourseModal">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h2>âœï¸ ê°•ì˜ ìˆ˜ì •</h2>
        <button class="modal-close" onclick="closeEditCourseModal()">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editCourseId" />
        <div class="admin-form-group">
          <label>ê°•ì˜ëª… *</label>
          <input type="text" id="editCourseName" />
        </div>
        <div class="admin-form-group">
          <label>ë‹´ë‹¹êµìˆ˜ëª… *</label>
          <input type="text" id="editProfessorName" />
        </div>
        <div class="admin-form-group">
          <label>ìˆ˜ê°•ìƒ ëª…ë‹¨</label>
          <textarea id="editStudentList"></textarea>
          <div class="help-text">í•œ ì¤„ì— í•œ ëª…ì”© ì…ë ¥í•´ì£¼ì„¸ìš”</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="ctrl-btn" onclick="closeEditCourseModal()">ì·¨ì†Œ</button>
        <button class="ctrl-btn primary" onclick="saveCourseEdit()">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ========== ì „ì²´ ì¶œì„ë¶€ ëª¨ë‹¬ (ìš´ì˜ììš©) ========== -->
  <div class="modal-overlay" id="allAttendanceModal">
    <div class="modal" style="max-width: 1000px; max-height: 95vh;">
      <div class="modal-header">
        <h2>ğŸ“‹ ì „ì²´ ì¶œì„ë¶€</h2>
        <button class="modal-close" onclick="closeAllAttendanceModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="all-attendance-filters">
          <label style="font-size:14px;color:#9ca3af;">ê°•ì˜ ì„ íƒ:</label>
          <select id="allAttendanceCourseSelect" onchange="renderAllAttendance()">
            <option value="all">ì „ì²´ ê°•ì˜</option>
          </select>
          <label style="font-size:14px;color:#9ca3af;margin-left:12px;">ì£¼ì°¨:</label>
          <select id="allAttendanceWeekSelect" onchange="renderAllAttendance()">
            <option value="all">ì „ì²´ ì£¼ì°¨</option>
            <option value="1">1ì£¼ì°¨</option>
            <option value="2">2ì£¼ì°¨</option>
            <option value="3">3ì£¼ì°¨</option>
            <option value="4">4ì£¼ì°¨</option>
            <option value="5">5ì£¼ì°¨</option>
            <option value="6">6ì£¼ì°¨</option>
            <option value="7">7ì£¼ì°¨</option>
            <option value="8">8ì£¼ì°¨</option>
            <option value="9">9ì£¼ì°¨</option>
            <option value="10">10ì£¼ì°¨</option>
            <option value="11">11ì£¼ì°¨</option>
            <option value="12">12ì£¼ì°¨</option>
            <option value="13">13ì£¼ì°¨</option>
            <option value="14">14ì£¼ì°¨</option>
            <option value="15">15ì£¼ì°¨</option>
            <option value="16">16ì£¼ì°¨</option>
          </select>
          <button class="ctrl-btn export-all-btn" onclick="exportAllAttendance()">ğŸ“¥ ì „ì²´ ë‚´ë³´ë‚´ê¸°</button>
        </div>
        <div id="allAttendanceContent">
          <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="ctrl-btn" onclick="closeAllAttendanceModal()">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ========== ë‚´ ì¶œì„í˜„í™© ëª¨ë‹¬ (í•™ìƒìš©) ========== -->
  <div class="modal-overlay" id="myAttendanceModal">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h2>ğŸ“‹ ë‚´ ì¶œì„í˜„í™©</h2>
        <button class="modal-close" onclick="closeMyAttendanceModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div id="myAttendanceInfo" style="margin-bottom: 16px;">
          <div style="font-size: 14px; color: #9ca3af;">ê°•ì˜ëª…</div>
          <div style="font-size: 18px; font-weight: 600; color: #60a5fa;" id="myCourseName">-</div>
        </div>
        <div id="myAttendanceSummary" style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
          <!-- ë™ì  ìƒì„± -->
        </div>
        <div id="myAttendanceList">
          <!-- ë™ì  ìƒì„± -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="ctrl-btn" onclick="closeMyAttendanceModal()">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <script>
    // ========== ìš´ì˜ì ì¸ì¦ ì •ë³´ ==========
    const ADMIN_CREDENTIALS = [
      { name: 'ìµœì¤€ì¼', employeeId: '19930007' },
      { name: 'ë°•ì„±ì£¼', employeeId: '01056568082' },
      { name: 'ê¹€í–¥ì§€', employeeId: '01022363841' },
      { name: 'ì¶”êµí˜„', employeeId: '01076796634' }
    ];

    // í˜„ì¬ ì‚¬ìš©ì ì •ë³´
    let currentUser = {
      role: 'student',  // 'admin', 'professor', 'student' - ê¸°ë³¸ê°’ í•™ìƒ
      name: '',
      course: ''
    };

    // ê°•ì˜ ë°ì´í„° (ìš´ì˜ìê°€ ê´€ë¦¬)
    let courseData = [];  // { id, name, professor, students: [] }
    let courseDataLoaded = false;  // ë°ì´í„° ë¡œë“œ ì™„ë£Œ ì—¬ë¶€

    // ========== Firebase ì„¤ì • ==========
    const firebaseConfig = {
      apiKey: "AIzaSyBBDEBlBzo2VWDNIJP4-wn5crBkXlum5zM",
      authDomain: "online-fcfe9.firebaseapp.com",
      databaseURL: "https://online-fcfe9-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "online-fcfe9",
      storageBucket: "online-fcfe9.firebasestorage.app",
      messagingSenderId: "484288182734",
      appId: "1:484288182734:web:c26552da2c688cc327d39f",
      measurementId: "G-0D3SF4FMH7"
    };

    // Firebase ì´ˆê¸°í™”
    let db = null;
    let firebaseEnabled = false;

    // Firebase ì—°ê²° ìƒíƒœ ì €ì¥
    let lastFirebaseStatus = { connected: false, message: 'í™•ì¸ ì¤‘...' };
    
    function updateFirebaseStatus(connected, message) {
      lastFirebaseStatus = { connected, message };
      applyFirebaseStatus();
    }
    
    function applyFirebaseStatus() {
      const statusEl = document.getElementById('firebaseStatus');
      if (statusEl) {
        if (lastFirebaseStatus.connected) {
          statusEl.innerHTML = `<span style="color: #10b981;">ğŸŸ¢ í´ë¼ìš°ë“œ ì—°ê²°ë¨</span>`;
        } else {
          statusEl.innerHTML = `<span style="color: #f59e0b;">ğŸŸ¡ ${lastFirebaseStatus.message || 'ë¡œì»¬ ëª¨ë“œ'}</span>`;
        }
      } else {
        // ìš”ì†Œê°€ ì•„ì§ ì—†ìœ¼ë©´ ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„
        setTimeout(applyFirebaseStatus, 500);
      }
    }

    try {
      if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
        firebase.initializeApp(firebaseConfig);
        db = firebase.database();
        firebaseEnabled = true;  // ì¼ë‹¨ í™œì„±í™”
        
        // Firebaseì—ì„œ ê°•ì˜ ë°ì´í„° ì‹¤ì‹œê°„ ìˆ˜ì‹  ì‹œì‘
        db.ref('courses').on('value', (snapshot) => {
          const data = snapshot.val();
          if (data) {
            courseData = Object.values(data);
          } else {
            courseData = [];
          }
          courseDataLoaded = true;
          console.log('ğŸ“¥ Firebaseì—ì„œ ê°•ì˜ ë°ì´í„° ë¡œë“œ:', courseData.length, 'ê°œ');
          if (courseData.length > 0) {
            console.log('ğŸ“‹ ë“±ë¡ëœ ê°•ì˜:', courseData.map(c => `${c.name}(${c.professor})`).join(', '));
          }
          
          // UI ì—…ë°ì´íŠ¸
          if (document.getElementById('courseModal')?.classList.contains('show')) {
            renderCourseList();
          }
          updateCourseDropdowns();
          updateLoadingStatus();
        });
        
        // ì—°ê²° ìƒíƒœ í™•ì¸
        db.ref('.info/connected').on('value', (snapshot) => {
          if (snapshot.val() === true) {
            updateFirebaseStatus(true);
            console.log('âœ… Firebase ì—°ê²° ì„±ê³µ');
          } else {
            updateFirebaseStatus(false, 'ì—°ê²° ëŠê¹€');
            console.log('âš ï¸ Firebase ì—°ê²° ëŠê¹€');
          }
        });
      } else {
        throw new Error('Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤');
      }
    } catch (error) {
      console.warn('âš ï¸ Firebase ë¯¸ì„¤ì •, ë¡œì»¬ ì €ì¥ì†Œ ì‚¬ìš©:', error.message);
      firebaseEnabled = false;
      setTimeout(() => updateFirebaseStatus(false, 'Firebase ì„¤ì • í•„ìš”'), 100);
      // ë¡œì»¬ ì €ì¥ì†Œì—ì„œ ë¡œë“œ
      const saved = localStorage.getItem('gcu_courses');
      if (saved) {
        courseData = JSON.parse(saved);
      }
      courseDataLoaded = true;
    }

    // DOM ìš”ì†Œ
    const loginOverlay = document.getElementById('loginOverlay');
    const mainApp = document.getElementById('mainApp');
    const btnAdmin = document.getElementById('btnAdmin');
    const btnProfessor = document.getElementById('btnProfessor');
    const btnStudent = document.getElementById('btnStudent');

    // ë¡œë”© ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateLoadingStatus() {
      const submitBtn = document.getElementById('submitBtn');
      if (submitBtn && courseDataLoaded) {
        submitBtn.disabled = false;
        submitBtn.textContent = 'ğŸš€ ê°•ì˜ì‹¤ ì…ì¥';
      }
    }
    
    // ê°•ì˜ ë°ì´í„° ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨
    function refreshCourseData() {
      if (firebaseEnabled && db) {
        db.ref('courses').once('value').then((snapshot) => {
          const data = snapshot.val();
          if (data) {
            courseData = Object.values(data);
          } else {
            courseData = [];
          }
          courseDataLoaded = true;
          console.log('ğŸ”„ ê°•ì˜ ë°ì´í„° ìƒˆë¡œê³ ì¹¨:', courseData.length, 'ê°œ');
        });
      }
    }

    // ê°•ì˜ ë°ì´í„° ì €ì¥ (Firebase ë˜ëŠ” localStorage)
    function saveCourseData() {
      if (firebaseEnabled && db) {
        // Firebaseì— ì €ì¥ (ë°°ì—´ì„ ê°ì²´ë¡œ ë³€í™˜)
        const coursesObj = {};
        courseData.forEach(course => {
          coursesObj[course.id] = course;
        });
        db.ref('courses').set(coursesObj)
          .then(() => console.log('ğŸ“¤ Firebaseì— ê°•ì˜ ë°ì´í„° ì €ì¥ ì™„ë£Œ'))
          .catch(err => console.error('Firebase ì €ì¥ ì˜¤ë¥˜:', err));
      } else {
        // ë¡œì»¬ ì €ì¥ì†Œì— ì €ì¥
        localStorage.setItem('gcu_courses', JSON.stringify(courseData));
      }
    }

    // ê°•ì˜ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
    function updateCourseDropdowns() {
      // ì¶œì„ë¶€ ê°•ì˜ ì„ íƒ ë“œë¡­ë‹¤ìš´
      const attendanceCourseSelect = document.getElementById('attendanceCourseSelect');
      if (attendanceCourseSelect) {
        const currentValue = attendanceCourseSelect.value;
        attendanceCourseSelect.innerHTML = '<option value="all">ì „ì²´ ê°•ì˜</option>' +
          courseData.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
        if (currentValue && courseData.find(c => c.name === currentValue)) {
          attendanceCourseSelect.value = currentValue;
        }
      }
    }

    // ì¶œì„ ë°ì´í„° ë¡œë“œ (Firebase ë˜ëŠ” localStorage)
    function loadAttendanceData(courseName) {
      return new Promise((resolve) => {
        const key = `attendance_${courseName}`;
        if (firebaseEnabled && db) {
          db.ref(`attendance/${courseName.replace(/[.#$\/\[\]]/g, '_')}`).once('value')
            .then(snapshot => {
              resolve(snapshot.val() || { weeks: {} });
            })
            .catch(() => resolve({ weeks: {} }));
        } else {
          const saved = localStorage.getItem(key);
          resolve(saved ? JSON.parse(saved) : { weeks: {} });
        }
      });
    }

    // ì¶œì„ ë°ì´í„° ì €ì¥ (Firebase ë˜ëŠ” localStorage)
    function saveAttendanceData(courseName, data) {
      const key = `attendance_${courseName}`;
      if (firebaseEnabled && db) {
        db.ref(`attendance/${courseName.replace(/[.#$\/\[\]]/g, '_')}`).set(data)
          .then(() => console.log('ğŸ“¤ ì¶œì„ ë°ì´í„° ì €ì¥ ì™„ë£Œ'))
          .catch(err => console.error('ì¶œì„ ì €ì¥ ì˜¤ë¥˜:', err));
      } else {
        localStorage.setItem(key, JSON.stringify(data));
      }
    }

    // ì—­í•  ì„ íƒ
    function selectRole(role) {
      currentUser.role = role;

      // ëª¨ë“  ë²„íŠ¼ ë¹„í™œì„±í™”
      btnAdmin.classList.remove('active', 'admin');
      btnProfessor.classList.remove('active');
      btnStudent.classList.remove('active');

      // í¼ ìš”ì†Œ
      const groupEmployeeId = document.getElementById('groupEmployeeId');
      const groupCourse = document.getElementById('groupCourse');
      const labelEmployeeId = document.getElementById('labelEmployeeId');
      const inputEmployeeId = document.getElementById('inputEmployeeId');
      const inputCourse = document.getElementById('inputCourse');
      const submitBtn = document.getElementById('submitBtn');

      if (role === 'admin') {
        btnAdmin.classList.add('active', 'admin');
        groupEmployeeId.classList.remove('hidden');
        groupCourse.classList.add('hidden');
        labelEmployeeId.textContent = 'ì‚¬ë²ˆ *';
        inputEmployeeId.placeholder = 'ì‚¬ë²ˆ ì…ë ¥';
        inputEmployeeId.required = true;
        inputCourse.required = false;
        submitBtn.textContent = 'âš™ï¸ ìš´ì˜ ì‹œì‘';
      } else if (role === 'professor') {
        btnProfessor.classList.add('active');
        groupEmployeeId.classList.add('hidden');
        groupCourse.classList.remove('hidden');
        inputEmployeeId.required = false;
        inputCourse.required = true;
        submitBtn.textContent = 'ğŸ‘¨â€ğŸ« êµìˆ˜ë¡œ ì…ì¥';
      } else {
        btnStudent.classList.add('active');
        groupEmployeeId.classList.add('hidden');
        groupCourse.classList.remove('hidden');
        inputEmployeeId.required = false;
        inputCourse.required = true;
        submitBtn.textContent = 'ğŸ‘¨â€ğŸ“ í•™ìƒìœ¼ë¡œ ì…ì¥';
      }
    }

    // ë¡œê·¸ì¸ ì²˜ë¦¬
    function handleLogin(e) {
      e.preventDefault();

      const name = document.getElementById('inputName').value.trim();
      const employeeId = document.getElementById('inputEmployeeId').value.trim();
      const course = document.getElementById('inputCourse').value.trim();

      // ìš´ì˜ì ë¡œê·¸ì¸
      if (currentUser.role === 'admin') {
        const validAdmin = ADMIN_CREDENTIALS.find(admin => admin.name === name && admin.employeeId === employeeId);
        if (!validAdmin) {
          alert('ìš´ì˜ì ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\nì´ë¦„ê³¼ ì‚¬ë²ˆ/ì „í™”ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
          return;
        }
        currentUser.name = name;
        currentUser.course = '';
        
        loginOverlay.classList.add('hidden');
        mainApp.classList.add('show');
        updateMainUI();
        return;
      }

      // êµìˆ˜/í•™ìƒ ë¡œê·¸ì¸
      if (!name || !course) {
        alert('ì´ë¦„ê³¼ ê°•ì˜ëª…ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      // ë°ì´í„° ë¡œë“œ í™•ì¸
      if (!courseDataLoaded) {
        alert('ê°•ì˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤.\nì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        return;
      }

      // ë””ë²„ê·¸: í˜„ì¬ ë“±ë¡ëœ ê°•ì˜ ì¶œë ¥
      console.log('ğŸ” ë¡œê·¸ì¸ ì‹œë„:', { name, course, role: currentUser.role });
      console.log('ğŸ“‹ ë“±ë¡ëœ ê°•ì˜ ëª©ë¡:', courseData);
      
      // ë””ë²„ê·¸: ì—­í•  í™•ì¸ (í™”ë©´ì— ì ì‹œ í‘œì‹œ)
      console.log(`ğŸ‘¤ ì„ íƒëœ ì—­í• : ${currentUser.role === 'professor' ? 'êµìˆ˜' : currentUser.role === 'student' ? 'í•™ìƒ' : 'ìš´ì˜ì'}`);

      // ê°•ì˜ ì¡´ì¬ í™•ì¸
      const courseInfo = courseData.find(c => c.name === course);
      if (!courseInfo) {
        const availableCourses = courseData.map(c => c.name).join(', ') || 'ì—†ìŒ';
        alert(`"${course}" ê°•ì˜ê°€ ë“±ë¡ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.\n\në“±ë¡ëœ ê°•ì˜: ${availableCourses}\n\nìš´ì˜ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.`);
        return;
      }

      // êµìˆ˜ ê²€ì¦
      if (currentUser.role === 'professor') {
        console.log('ğŸ” êµìˆ˜ ê²€ì¦:', { ì…ë ¥ì´ë¦„: name, ë“±ë¡êµìˆ˜: courseInfo.professor });
        if (courseInfo.professor !== name) {
          alert(`"${course}" ê°•ì˜ì˜ ë‹´ë‹¹êµìˆ˜ê°€ ì•„ë‹™ë‹ˆë‹¤.\n\nì…ë ¥í•œ ì´ë¦„: ${name}\në“±ë¡ëœ ë‹´ë‹¹êµìˆ˜: ${courseInfo.professor}`);
          return;
        }
      }

      // í•™ìƒ ê²€ì¦
      if (currentUser.role === 'student') {
        console.log('ğŸ” í•™ìƒ ê²€ì¦:', { ì…ë ¥ì´ë¦„: name, ìˆ˜ê°•ìƒëª©ë¡: courseInfo.students });
        if (!courseInfo.students || !courseInfo.students.includes(name)) {
          const studentList = courseInfo.students?.join(', ') || 'ì—†ìŒ';
          alert(`"${course}" ê°•ì˜ì˜ ìˆ˜ê°•ìƒ ëª…ë‹¨ì— "${name}"ì´(ê°€) ì—†ìŠµë‹ˆë‹¤.\n\në“±ë¡ëœ ìˆ˜ê°•ìƒ: ${studentList}\n\nìš´ì˜ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.`);
          return;
        }
      }

      console.log('âœ… ë¡œê·¸ì¸ ì„±ê³µ:', { name, course, role: currentUser.role });

      currentUser.name = name;
      currentUser.course = course;

      // ë¡œê·¸ì¸ í™”ë©´ ìˆ¨ê¸°ê³  ë©”ì¸ ì•± í‘œì‹œ
      loginOverlay.classList.add('hidden');
      mainApp.classList.add('show');

      // UI ì—…ë°ì´íŠ¸
      updateMainUI();

      // Jitsi ê°•ì˜ì‹¤ ë¡œë“œ (ìš´ì˜ìê°€ ì•„ë‹Œ ê²½ìš°)
      if (currentUser.role !== 'admin') {
        console.log('ğŸš€ Jitsi ë¡œë”© ì‹œì‘, course:', course);
        if (!course || course.trim() === '') {
          alert('ì˜¤ë¥˜: ê°•ì˜ëª…ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!\nì…ë ¥ëœ course: "' + course + '"');
          return;
        }
        loadRoom(course);
      }
    }

    // ë©”ì¸ UI ì—…ë°ì´íŠ¸
    function updateMainUI() {
      const userBadge = document.getElementById('userBadge');
      const badgeIcon = document.getElementById('badgeIcon');
      const badgeText = document.getElementById('badgeText');
      const adminControls = document.getElementById('adminControls');
      const professorHeaderBtns = document.getElementById('professorHeaderBtns');
      const studentHeaderBtns = document.getElementById('studentHeaderBtns');

      // ëª¨ë“  ì»¨íŠ¸ë¡¤ ìˆ¨ê¸°ê¸°
      adminControls.classList.remove('show');
      professorHeaderBtns.classList.remove('show');
      studentHeaderBtns.classList.remove('show');

      if (currentUser.role === 'admin') {
        userBadge.className = 'user-badge admin';
        badgeIcon.textContent = 'âš™ï¸';
        badgeText.textContent = `${currentUser.name} ìš´ì˜ì`;
        adminControls.classList.add('show');
        // ìš´ì˜ìëŠ” Jitsi í”„ë ˆì„ ìˆ¨ê¸°ê¸°
        document.getElementById('jitsiFrame').style.display = 'none';
        document.querySelector('.jitsi-header').innerHTML = '<div style="text-align:center;padding:40px;color:#9ca3af;">ìš´ì˜ì ëª¨ë“œ - ìƒë‹¨ ë©”ë‰´ì—ì„œ ê°•ì˜ë¥¼ ê´€ë¦¬í•˜ì„¸ìš”</div>';
      } else if (currentUser.role === 'professor') {
        userBadge.className = 'user-badge professor';
        badgeIcon.textContent = 'ğŸ‘¨â€ğŸ«';
        badgeText.textContent = `${currentUser.name} êµìˆ˜`;
        professorHeaderBtns.classList.add('show');
        document.getElementById('jitsiFrame').style.display = '';
        loadAttendanceDataLocal();
        updateClassUI();
      } else {
        userBadge.className = 'user-badge student';
        badgeIcon.textContent = 'ğŸ‘¨â€ğŸ“';
        badgeText.textContent = `${currentUser.name} í•™ìƒ`;
        studentHeaderBtns.classList.add('show');
        document.getElementById('jitsiFrame').style.display = '';
        checkStudentAttendance();
      }
    }

    // ë¡œê·¸ì•„ì›ƒ
    function handleLogout() {
      const message = currentUser.role === 'admin' ? 'ìš´ì˜ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?' : 'ê°•ì˜ì‹¤ì—ì„œ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?';
      if (confirm(message)) {
        // Jitsi í”„ë ˆì„ ì´ˆê¸°í™”
        document.getElementById('jitsiFrame').src = '';
        document.getElementById('jitsiFrame').style.display = '';

        // í¼ ì´ˆê¸°í™”
        document.getElementById('loginForm').reset();
        selectRole('student');

        // í™”ë©´ ì „í™˜
        mainApp.classList.remove('show');
        loginOverlay.classList.remove('hidden');

        // ì‚¬ìš©ì ì •ë³´ ì´ˆê¸°í™”
        currentUser = {
          role: 'professor',
          name: '',
          course: ''
        };

        // Jitsi í—¤ë” ë³µì›
        document.querySelector('.jitsi-header').innerHTML = `
          <div>
            í˜„ì¬ ê°•ì˜ëª…: <span class="room-name-display" id="roomNameDisplay">-</span>
            <span id="serverStatus" style="margin-left: 12px; font-size: 12px; color: #60a5fa;"></span>
          </div>
          <div class="small-note">
            ì²˜ìŒ ì ‘ì† ì‹œ ë¸Œë¼ìš°ì €ê°€ ì¹´ë©”ë¼/ë§ˆì´í¬ ê¶Œí•œì„ ìš”ì²­í•˜ë©´ <b>í—ˆìš©</b>ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
          </div>
        `;
      }
    }

    // ========== ê°•ì˜ ê´€ë¦¬ (ìš´ì˜ììš©) ==========
    
    function openCourseModal() {
      document.getElementById('courseModal').classList.add('show');
      renderCourseList();
    }

    function closeCourseModal() {
      document.getElementById('courseModal').classList.remove('show');
    }

    function addCourse() {
      const name = document.getElementById('newCourseName').value.trim();
      const professor = document.getElementById('newProfessorName').value.trim();
      const studentText = document.getElementById('newStudentList').value.trim();

      if (!name || !professor) {
        alert('ê°•ì˜ëª…ê³¼ ë‹´ë‹¹êµìˆ˜ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      // ì¤‘ë³µ í™•ì¸
      if (courseData.find(c => c.name === name)) {
        alert('ì´ë¯¸ ë“±ë¡ëœ ê°•ì˜ëª…ì…ë‹ˆë‹¤.');
        return;
      }

      // ìˆ˜ê°•ìƒ íŒŒì‹±
      const students = studentText ? studentText.split('\n').map(s => s.trim()).filter(s => s) : [];

      const newCourse = {
        id: Date.now().toString(),
        name,
        professor,
        students
      };

      courseData.push(newCourse);
      saveCourseData();

      // ì¶œì„ ë°ì´í„°ë„ ì´ˆê¸°í™”
      const attendanceKey = `attendance_${name}`;
      if (!localStorage.getItem(attendanceKey)) {
        localStorage.setItem(attendanceKey, JSON.stringify({
          students: students,
          classStartTime: null,
          classEndTime: null,
          isClassActive: false,
          currentWeek: 1,
          records: {}
        }));
      }

      // í¼ ì´ˆê¸°í™”
      document.getElementById('newCourseName').value = '';
      document.getElementById('newProfessorName').value = '';
      document.getElementById('newStudentList').value = '';

      renderCourseList();
      alert(`"${name}" ê°•ì˜ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    }

    function renderCourseList() {
      const container = document.getElementById('courseList');

      if (courseData.length === 0) {
        container.innerHTML = '<div class="no-courses">ë“±ë¡ëœ ê°•ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      container.innerHTML = courseData.map(course => `
        <div class="course-card">
          <div class="course-card-header">
            <span class="course-card-title">ğŸ“– ${course.name}</span>
          </div>
          <div class="course-card-info">
            <span>ğŸ‘¨â€ğŸ« ë‹´ë‹¹êµìˆ˜: <strong>${course.professor}</strong></span>
            <span>ğŸ‘¥ ìˆ˜ê°•ìƒ: <strong>${course.students.length}ëª…</strong></span>
          </div>
          <div class="course-card-actions">
            <button class="ctrl-btn" onclick="editCourse('${course.id}')">âœï¸ ìˆ˜ì •</button>
            <button class="ctrl-btn danger" onclick="deleteCourse('${course.id}')">ğŸ—‘ï¸ ì‚­ì œ</button>
          </div>
        </div>
      `).join('');
    }

    function editCourse(courseId) {
      const course = courseData.find(c => c.id === courseId);
      if (!course) return;

      document.getElementById('editCourseId').value = courseId;
      document.getElementById('editCourseName').value = course.name;
      document.getElementById('editProfessorName').value = course.professor;
      document.getElementById('editStudentList').value = course.students.join('\n');

      document.getElementById('editCourseModal').classList.add('show');
    }

    function closeEditCourseModal() {
      document.getElementById('editCourseModal').classList.remove('show');
    }

    function saveCourseEdit() {
      const courseId = document.getElementById('editCourseId').value;
      const name = document.getElementById('editCourseName').value.trim();
      const professor = document.getElementById('editProfessorName').value.trim();
      const studentText = document.getElementById('editStudentList').value.trim();

      if (!name || !professor) {
        alert('ê°•ì˜ëª…ê³¼ ë‹´ë‹¹êµìˆ˜ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      const courseIndex = courseData.findIndex(c => c.id === courseId);
      if (courseIndex === -1) return;

      const oldName = courseData[courseIndex].name;
      const students = studentText ? studentText.split('\n').map(s => s.trim()).filter(s => s) : [];

      courseData[courseIndex] = {
        ...courseData[courseIndex],
        name,
        professor,
        students
      };

      saveCourseData();

      // ì¶œì„ ë°ì´í„° ì—…ë°ì´íŠ¸
      const attendanceKey = `attendance_${name}`;
      const oldAttendanceKey = `attendance_${oldName}`;
      
      // ê°•ì˜ëª…ì´ ë³€ê²½ëœ ê²½ìš° ì¶œì„ ë°ì´í„° í‚¤ë„ ë³€ê²½
      if (oldName !== name) {
        const oldData = localStorage.getItem(oldAttendanceKey);
        if (oldData) {
          localStorage.setItem(attendanceKey, oldData);
          localStorage.removeItem(oldAttendanceKey);
        }
      }

      // ìˆ˜ê°•ìƒ ëª©ë¡ ì—…ë°ì´íŠ¸
      const attendanceData = localStorage.getItem(attendanceKey);
      if (attendanceData) {
        const data = JSON.parse(attendanceData);
        data.students = students;
        localStorage.setItem(attendanceKey, JSON.stringify(data));
      }

      closeEditCourseModal();
      renderCourseList();
      alert('ê°•ì˜ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    function deleteCourse(courseId) {
      const course = courseData.find(c => c.id === courseId);
      if (!course) return;

      if (!confirm(`"${course.name}" ê°•ì˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì¶œì„ ë°ì´í„°ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.`)) return;

      // ì¶œì„ ë°ì´í„° ì‚­ì œ
      localStorage.removeItem(`attendance_${course.name}`);

      courseData = courseData.filter(c => c.id !== courseId);
      saveCourseData();
      renderCourseList();
      alert('ê°•ì˜ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    function openAllAttendanceModal() {
      document.getElementById('allAttendanceModal').classList.add('show');
      
      // ê°•ì˜ ì„ íƒ ì˜µì…˜ ì—…ë°ì´íŠ¸
      const courseSelect = document.getElementById('allAttendanceCourseSelect');
      courseSelect.innerHTML = '<option value="all">ì „ì²´ ê°•ì˜</option>';
      courseData.forEach(course => {
        courseSelect.innerHTML += `<option value="${course.name}">${course.name}</option>`;
      });
      
      renderAllAttendance();
    }

    function closeAllAttendanceModal() {
      document.getElementById('allAttendanceModal').classList.remove('show');
    }

    function renderAllAttendance() {
      const selectedCourse = document.getElementById('allAttendanceCourseSelect').value;
      const selectedWeek = document.getElementById('allAttendanceWeekSelect').value;
      const container = document.getElementById('allAttendanceContent');

      if (courseData.length === 0) {
        container.innerHTML = '<div class="no-courses">ë“±ë¡ëœ ê°•ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      const coursesToShow = selectedCourse === 'all' 
        ? courseData 
        : courseData.filter(c => c.name === selectedCourse);

      let html = '';

      coursesToShow.forEach(course => {
        const attendanceKey = `attendance_${course.name}`;
        const savedData = localStorage.getItem(attendanceKey);
        const attendanceInfo = savedData ? JSON.parse(savedData) : null;

        html += `<div class="course-attendance-section">`;
        html += `<div class="course-attendance-header">`;
        html += `<div>
          <div class="course-attendance-title">ğŸ“– ${course.name}</div>
          <div class="course-attendance-meta">ë‹´ë‹¹êµìˆ˜: ${course.professor} | ìˆ˜ê°•ìƒ: ${course.students.length}ëª…</div>
        </div>`;
        html += `</div>`;

        // ì£¼ì°¨ íƒ­ ìƒì„±
        if (selectedWeek === 'all') {
          html += `<div class="week-tabs" id="weekTabs_${course.name.replace(/\s/g, '_')}">`;
          for (let w = 1; w <= 16; w++) {
            const hasData = attendanceInfo && attendanceInfo.records && attendanceInfo.records[w];
            const dataClass = hasData ? 'has-data' : '';
            html += `<button class="week-tab ${dataClass} ${w === 1 ? 'active' : ''}" 
                      onclick="showWeekAttendance('${course.name}', ${w}, this)">${w}ì£¼</button>`;
          }
          html += `</div>`;
        }

        // ì¶œì„ í…Œì´ë¸”
        const weekToShow = selectedWeek === 'all' ? 1 : parseInt(selectedWeek);
        html += renderCourseWeekAttendance(course, attendanceInfo, weekToShow);

        html += `</div>`;
      });

      container.innerHTML = html || '<div class="no-courses">í‘œì‹œí•  ì¶œì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    }

    function renderCourseWeekAttendance(course, attendanceInfo, week) {
      const records = attendanceInfo && attendanceInfo.records ? attendanceInfo.records[week] : null;
      
      let html = `<div class="attendance-table-wrapper" id="attendanceTable_${course.name.replace(/\s/g, '_')}">`;
      html += `<table class="mini-attendance-table">`;
      html += `<thead><tr>
        <th style="width:50px;">ë²ˆí˜¸</th>
        <th>ì´ë¦„</th>
        <th style="width:100px;">ì…ì¥ì‹œê°„</th>
        <th style="width:100px;">í‡´ì¥ì‹œê°„</th>
        <th style="width:80px;">ìƒíƒœ</th>
      </tr></thead>`;
      html += `<tbody>`;

      if (course.students.length === 0) {
        html += `<tr><td colspan="5" style="text-align:center;color:#6b7280;padding:20px;">ë“±ë¡ëœ ìˆ˜ê°•ìƒì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
      } else {
        let presentCount = 0, lateCount = 0, earlyLeaveCount = 0, absentCount = 0;

        course.students.forEach((name, index) => {
          const record = records ? records[name] : null;
          const status = record ? record.status : 'pending';

          if (status === 'present') presentCount++;
          else if (status === 'late') lateCount++;
          else if (status === 'early-leave') earlyLeaveCount++;
          else if (status === 'absent') absentCount++;

          const statusLabel = {
            'present': 'ì¶œì„',
            'late': 'ì§€ê°',
            'early-leave': 'ì¡°í‡´',
            'absent': 'ê²°ì„',
            'pending': 'ë¯¸ì •'
          };

          const joinTime = record && record.joinTime ? formatTimeFromString(record.joinTime) : '-';
          const leaveTime = record && record.leaveTime ? formatTimeFromString(record.leaveTime) : '-';

          html += `<tr>
            <td>${index + 1}</td>
            <td>${name}</td>
            <td style="font-size:11px;color:#6b7280;">${joinTime}</td>
            <td style="font-size:11px;color:#6b7280;">${leaveTime}</td>
            <td><span class="attendance-status ${status}">${statusLabel[status]}</span></td>
          </tr>`;
        });

        // ìš”ì•½ í–‰
        html += `<tr style="background:#0f172a;">
          <td colspan="5" style="padding:10px;">
            <span class="attendance-status present">ì¶œì„ ${presentCount}</span>
            <span class="attendance-status late" style="margin-left:8px;">ì§€ê° ${lateCount}</span>
            <span class="attendance-status early-leave" style="margin-left:8px;">ì¡°í‡´ ${earlyLeaveCount}</span>
            <span class="attendance-status absent" style="margin-left:8px;">ê²°ì„ ${absentCount}</span>
          </td>
        </tr>`;
      }

      html += `</tbody></table></div>`;
      return html;
    }

    function showWeekAttendance(courseName, week, btn) {
      // íƒ­ í™œì„±í™”
      const tabContainer = btn.parentElement;
      tabContainer.querySelectorAll('.week-tab').forEach(t => t.classList.remove('active'));
      btn.classList.add('active');

      // í…Œì´ë¸” ì—…ë°ì´íŠ¸
      const course = courseData.find(c => c.name === courseName);
      if (!course) return;

      const attendanceKey = `attendance_${courseName}`;
      const savedData = localStorage.getItem(attendanceKey);
      const attendanceInfo = savedData ? JSON.parse(savedData) : null;

      const tableContainer = document.getElementById(`attendanceTable_${courseName.replace(/\s/g, '_')}`);
      if (tableContainer) {
        tableContainer.outerHTML = renderCourseWeekAttendance(course, attendanceInfo, week);
      }
    }

    function formatTimeFromString(timeStr) {
      if (!timeStr) return '-';
      const date = new Date(timeStr);
      return date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }

    function exportAllAttendance() {
      const selectedCourse = document.getElementById('allAttendanceCourseSelect').value;
      const selectedWeek = document.getElementById('allAttendanceWeekSelect').value;

      const coursesToExport = selectedCourse === 'all' 
        ? courseData 
        : courseData.filter(c => c.name === selectedCourse);

      if (coursesToExport.length === 0) {
        alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      let csv = '';
      const statusLabel = {
        'present': 'ì¶œì„',
        'late': 'ì§€ê°',
        'early-leave': 'ì¡°í‡´',
        'absent': 'ê²°ì„',
        'pending': 'ë¯¸ì •'
      };

      coursesToExport.forEach(course => {
        const attendanceKey = `attendance_${course.name}`;
        const savedData = localStorage.getItem(attendanceKey);
        const attendanceInfo = savedData ? JSON.parse(savedData) : null;

        const weeksToExport = selectedWeek === 'all' 
          ? Array.from({length: 16}, (_, i) => i + 1)
          : [parseInt(selectedWeek)];

        weeksToExport.forEach(week => {
          const records = attendanceInfo && attendanceInfo.records ? attendanceInfo.records[week] : null;
          
          // ë°ì´í„°ê°€ ìˆëŠ” ì£¼ì°¨ë§Œ ë‚´ë³´ë‚´ê¸°
          if (!records && selectedWeek === 'all') return;

          csv += `\n[${course.name}] ${week}ì£¼ì°¨ - ë‹´ë‹¹êµìˆ˜: ${course.professor}\n`;
          csv += `ë²ˆí˜¸,ì´ë¦„,ì…ì¥ì‹œê°„,í‡´ì¥ì‹œê°„,ì¶œì„ìƒíƒœ\n`;

          course.students.forEach((name, index) => {
            const record = records ? records[name] : null;
            const status = record ? record.status : 'pending';
            const joinTime = record && record.joinTime ? formatTimeFromString(record.joinTime) : '-';
            const leaveTime = record && record.leaveTime ? formatTimeFromString(record.leaveTime) : '-';

            csv += `${index + 1},${name},${joinTime},${leaveTime},${statusLabel[status]}\n`;
          });
        });
      });

      if (!csv.trim()) {
        alert('ë‚´ë³´ë‚¼ ì¶œì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const filename = selectedCourse === 'all' 
        ? `ì „ì²´ì¶œì„ë¶€_${selectedWeek === 'all' ? 'ì „ì²´ì£¼ì°¨' : selectedWeek + 'ì£¼ì°¨'}.csv`
        : `ì¶œì„ë¶€_${selectedCourse}_${selectedWeek === 'all' ? 'ì „ì²´ì£¼ì°¨' : selectedWeek + 'ì£¼ì°¨'}.csv`;
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
    }

    // ì„œë²„ ëª©ë¡
    const JITSI_SERVERS = [
      'https://meet.ffmuc.net',
      'https://meet.jit.si',
      'https://jitsi.riot.im',
      'https://meet.scheible.it'
    ];
    
    let currentServerIndex = 0;
    let connectionTimeout = null;
    let currentRoomName = '';
    let currentDisplayName = '';

    // Jitsi URL ìƒì„±
    function buildJitsiUrl(serverUrl, roomName, displayName) {
      const cleanRoom = roomName.trim().replace(/\s+/g, '-');
      const encodedRoom = encodeURIComponent(cleanRoom);
      const encodedName = encodeURIComponent(displayName);
      return `${serverUrl}/${encodedRoom}#userInfo.displayName="${encodedName}"`;
    }

    // ì„œë²„ ìƒíƒœ í‘œì‹œ
    function updateServerStatus(message, isError = false) {
      const statusEl = document.getElementById('serverStatus');
      if (statusEl) {
        statusEl.textContent = message;
        statusEl.style.color = isError ? '#f87171' : '#60a5fa';
      }
    }

    // ë‹¤ìŒ ì„œë²„ ì‹œë„
    function tryNextServer() {
      currentServerIndex++;
      
      if (currentServerIndex >= JITSI_SERVERS.length) {
        // ëª¨ë“  ì„œë²„ ì‹œë„ ì‹¤íŒ¨
        currentServerIndex = 0;
        updateServerStatus('âŒ ëª¨ë“  ì„œë²„ ì ‘ì† ì‹¤íŒ¨. ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', true);
        return;
      }
      
      const nextServer = JITSI_SERVERS[currentServerIndex];
      updateServerStatus(`ğŸ”„ ì„œë²„ ë³€ê²½ ì¤‘... (${currentServerIndex + 1}/${JITSI_SERVERS.length})`);
      
      // ì„œë²„ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
      const serverSelect = document.getElementById('serverSelect');
      if (serverSelect) {
        serverSelect.value = nextServer;
      }
      
      // ìƒˆ ì„œë²„ë¡œ ì ‘ì† ì‹œë„
      setTimeout(() => {
        loadRoomWithServer(nextServer);
      }, 1000);
    }

    // íŠ¹ì • ì„œë²„ë¡œ ê°•ì˜ì‹¤ ë¡œë”©
    function loadRoomWithServer(serverUrl) {
      if (!currentRoomName || currentRoomName.trim() === '') {
        console.error('âŒ ê°•ì˜ëª…ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤');
        updateServerStatus('âŒ ê°•ì˜ëª…ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤', true);
        alert('ì˜¤ë¥˜: ê°•ì˜ëª…ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\ncurrentRoomName: ' + currentRoomName);
        return;
      }
      
      const url = buildJitsiUrl(serverUrl, currentRoomName, currentDisplayName);
      const iframe = document.getElementById('jitsiFrame');
      const loadingEl = document.getElementById('jitsiLoading');
      const debugInfo = document.getElementById('debugInfo');
      
      console.log('ğŸ”— Jitsi ì ‘ì† ì‹œë„');
      console.log('  - URL:', url);
      console.log('  - ê°•ì˜ëª…:', currentRoomName);
      console.log('  - í‘œì‹œì´ë¦„:', currentDisplayName);
      
      // ê¸°ì¡´ íƒ€ì„ì•„ì›ƒ ì·¨ì†Œ
      if (connectionTimeout) {
        clearTimeout(connectionTimeout);
      }
      
      // ë¡œë”© í‘œì‹œ
      if (loadingEl) loadingEl.style.display = 'block';
      if (debugInfo) debugInfo.textContent = `URL: ${url.substring(0, 50)}...`;
      
      updateServerStatus(`ğŸ”— ${serverUrl.replace('https://', '')} ì ‘ì† ì¤‘...`);
      
      // iframe ë¡œë“œ
      console.log('ğŸ“º iframe.src ì„¤ì •:', url);
      iframe.src = url;
      
      // 15ì´ˆ íƒ€ì„ì•„ì›ƒ ì„¤ì •
      connectionTimeout = setTimeout(() => {
        updateServerStatus(`âš ï¸ ${serverUrl.replace('https://', '')} ì‘ë‹µ ì—†ìŒ. ë‹¤ë¥¸ ì„œë²„ ì‹œë„ ì¤‘...`, true);
        tryNextServer();
      }, 15000);
    }

    // iframe ë¡œë“œ ì™„ë£Œ ê°ì§€
    function onJitsiLoaded() {
      const iframe = document.getElementById('jitsiFrame');
      const loadingEl = document.getElementById('jitsiLoading');
      
      // ë¹ˆ srcì´ë©´ ë¬´ì‹œ
      if (!iframe.src || iframe.src === '' || iframe.src === 'about:blank' || iframe.src === window.location.href) {
        console.log('â­ï¸ ë¹ˆ iframe ë¡œë“œ ë¬´ì‹œ');
        return;
      }
      
      console.log('âœ… iframe ë¡œë“œ ì™„ë£Œ:', iframe.src);
      
      // ë¡œë”© ìˆ¨ê¸°ê¸°
      if (loadingEl) loadingEl.style.display = 'none';
      
      if (connectionTimeout) {
        clearTimeout(connectionTimeout);
        connectionTimeout = null;
      }
      const serverUrl = JITSI_SERVERS[currentServerIndex];
      updateServerStatus(`âœ… ${serverUrl.replace('https://', '')} ì—°ê²°ë¨`);
    }

    // ê°•ì˜ì‹¤ ì„œë²„ ì •ë³´ ì €ì¥ (Firebase)
    function saveRoomServer(roomName, serverUrl) {
      if (firebaseEnabled && db) {
        const safeRoomName = roomName.replace(/[.#$\/\[\]]/g, '_');
        db.ref(`activeRooms/${safeRoomName}`).set({
          server: serverUrl,
          professor: currentUser.name,
          startedAt: Date.now()
        }).then(() => {
          console.log('ğŸ“¤ ê°•ì˜ì‹¤ ì„œë²„ ì •ë³´ ì €ì¥:', serverUrl);
        }).catch(err => console.error('ì„œë²„ ì •ë³´ ì €ì¥ ì˜¤ë¥˜:', err));
      }
    }

    // ê°•ì˜ì‹¤ ì„œë²„ ì •ë³´ ì¡°íšŒ (Firebase)
    function getRoomServer(roomName) {
      return new Promise((resolve) => {
        if (firebaseEnabled && db) {
          const safeRoomName = roomName.replace(/[.#$\/\[\]]/g, '_');
          db.ref(`activeRooms/${safeRoomName}`).once('value')
            .then(snapshot => {
              const data = snapshot.val();
              if (data && data.server) {
                resolve(data);
              } else {
                resolve(null);
              }
            })
            .catch(() => resolve(null));
        } else {
          resolve(null);
        }
      });
    }

    // ê°•ì˜ì‹¤ ë¡œë”©
    async function loadRoom(roomName) {
      console.log('ğŸ“ loadRoom í˜¸ì¶œë¨:', roomName);
      
      if (!roomName || roomName.trim() === '') {
        console.error('âŒ loadRoom: ê°•ì˜ëª…ì´ ë¹„ì–´ìˆìŒ');
        alert('ê°•ì˜ëª…ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        return;
      }
      
      // êµìˆ˜: [êµìˆ˜] ì„±ëª…, í•™ìƒ: [í•™ìƒ] ì„±ëª…
      currentDisplayName = currentUser.role === 'professor' 
        ? `[êµìˆ˜] ${currentUser.name}` 
        : `[í•™ìƒ] ${currentUser.name}`;
      
      currentRoomName = roomName;
      document.getElementById('roomNameDisplay').textContent = roomName;
      console.log('ğŸ“‹ roomNameDisplay ì—…ë°ì´íŠ¸:', roomName);
      
      // ì„ íƒëœ ì„œë²„
      const serverSelect = document.getElementById('serverSelect');
      let selectedServer = serverSelect ? serverSelect.value : JITSI_SERVERS[0];
      
      if (currentUser.role === 'professor') {
        // êµìˆ˜: ì„ íƒí•œ ì„œë²„ë¡œ ì ‘ì†í•˜ê³  Firebaseì— ì €ì¥
        currentServerIndex = JITSI_SERVERS.indexOf(selectedServer);
        if (currentServerIndex === -1) currentServerIndex = 0;
        
        saveRoomServer(roomName, JITSI_SERVERS[currentServerIndex]);
        loadRoomWithServer(JITSI_SERVERS[currentServerIndex]);
        
      } else {
        // í•™ìƒ: Firebaseì—ì„œ êµìˆ˜ê°€ ì‚¬ìš© ì¤‘ì¸ ì„œë²„ í™•ì¸
        updateServerStatus('ğŸ” êµìˆ˜ë‹˜ ì„œë²„ í™•ì¸ ì¤‘...');
        
        const roomInfo = await getRoomServer(roomName);
        
        if (roomInfo && roomInfo.server) {
          // êµìˆ˜ê°€ ì‚¬ìš© ì¤‘ì¸ ì„œë²„ë¡œ ìë™ ì—°ê²°
          selectedServer = roomInfo.server;
          currentServerIndex = JITSI_SERVERS.indexOf(selectedServer);
          if (currentServerIndex === -1) currentServerIndex = 0;
          
          // ì„œë²„ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
          if (serverSelect) {
            serverSelect.value = selectedServer;
          }
          
          updateServerStatus(`ğŸ‘¨â€ğŸ« ${roomInfo.professor} êµìˆ˜ë‹˜ ì„œë²„ë¡œ ì—°ê²° ì¤‘...`);
          console.log(`ğŸ“¥ êµìˆ˜ë‹˜ ì„œë²„ í™•ì¸: ${selectedServer}`);
          
          loadRoomWithServer(selectedServer);
        } else {
          // êµìˆ˜ ì •ë³´ ì—†ìœ¼ë©´ ì„ íƒí•œ ì„œë²„ë¡œ ì ‘ì†
          currentServerIndex = JITSI_SERVERS.indexOf(selectedServer);
          if (currentServerIndex === -1) currentServerIndex = 0;
          
          updateServerStatus('âš ï¸ êµìˆ˜ë‹˜ì´ ì•„ì§ ì ‘ì†í•˜ì§€ ì•ŠìŒ. ì„ íƒí•œ ì„œë²„ë¡œ ì—°ê²°...');
          loadRoomWithServer(JITSI_SERVERS[currentServerIndex]);
        }
      }
    }

    // ë””ë²„ê·¸: ìˆ˜ë™ Jitsi í…ŒìŠ¤íŠ¸ (ì½˜ì†”ì—ì„œ testJitsi() ì‹¤í–‰)
    window.testJitsi = function() {
      const testRoom = prompt('í…ŒìŠ¤íŠ¸í•  ê°•ì˜ëª…:', 'í…ŒìŠ¤íŠ¸ê°•ì˜ì‹¤');
      if (testRoom) {
        currentRoomName = testRoom;
        currentDisplayName = '[í…ŒìŠ¤íŠ¸] ì‚¬ìš©ì';
        document.getElementById('roomNameDisplay').textContent = testRoom;
        loadRoomWithServer(JITSI_SERVERS[0]);
        console.log('ğŸ§ª í…ŒìŠ¤íŠ¸ Jitsi ë¡œë”©:', testRoom);
      }
    };

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    window.addEventListener('DOMContentLoaded', () => {
      selectRole('student');
      // Firebase ìƒíƒœ í‘œì‹œ ì ìš©
      applyFirebaseStatus();
    });

    // ========== ì¶œì„ ê´€ë¦¬ ì‹œìŠ¤í…œ ==========
    
    // ì¶œì„ ë°ì´í„° êµ¬ì¡°
    let attendanceData = {
      students: [],        // ìˆ˜ê°•ìƒ ëª©ë¡
      classStartTime: null, // ìˆ˜ì—… ì‹œì‘ ì‹œê°„
      classEndTime: null,   // ìˆ˜ì—… ì¢…ë£Œ ì‹œê°„
      isClassActive: false, // ìˆ˜ì—… ì§„í–‰ ì¤‘ ì—¬ë¶€
      currentWeek: 1,       // í˜„ì¬ ì£¼ì°¨
      records: {}           // ì£¼ì°¨ë³„ ì¶œì„ ê¸°ë¡ { week: { studentName: { joinTime, leaveTime, status } } }
    };

    // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ í‚¤ ìƒì„± (ê°•ì˜ëª… ê¸°ë°˜)
    function getStorageKey() {
      return `attendance_${currentUser.course}`;
    }

    function getFirebaseAttendanceKey() {
      return currentUser.course.replace(/[.#$\/\[\]]/g, '_');
    }

    // ë°ì´í„° ì €ì¥ (Firebase ë˜ëŠ” localStorage)
    function saveAttendanceDataLocal() {
      const dataToSave = {
        ...attendanceData,
        classStartTime: attendanceData.classStartTime ? attendanceData.classStartTime.toISOString() : null,
        classEndTime: attendanceData.classEndTime ? attendanceData.classEndTime.toISOString() : null
      };
      
      if (firebaseEnabled && db) {
        db.ref(`attendance/${getFirebaseAttendanceKey()}`).set(dataToSave)
          .then(() => console.log('ğŸ“¤ ì¶œì„ ë°ì´í„° Firebase ì €ì¥ ì™„ë£Œ'))
          .catch(err => console.error('ì¶œì„ ì €ì¥ ì˜¤ë¥˜:', err));
      }
      // ë¡œì»¬ì—ë„ ì €ì¥ (ë°±ì—…)
      localStorage.setItem(getStorageKey(), JSON.stringify(dataToSave));
    }

    // ë°ì´í„° ë¡œë“œ (Firebase ë˜ëŠ” localStorage)
    function loadAttendanceDataLocal() {
      if (firebaseEnabled && db) {
        db.ref(`attendance/${getFirebaseAttendanceKey()}`).once('value')
          .then(snapshot => {
            const data = snapshot.val();
            if (data) {
              attendanceData = data;
              // ë‚ ì§œ ë¬¸ìì—´ì„ Date ê°ì²´ë¡œ ë³€í™˜
              if (attendanceData.classStartTime) {
                attendanceData.classStartTime = new Date(attendanceData.classStartTime);
              }
              if (attendanceData.classEndTime) {
                attendanceData.classEndTime = new Date(attendanceData.classEndTime);
              }
              console.log('ğŸ“¥ ì¶œì„ ë°ì´í„° Firebaseì—ì„œ ë¡œë“œ');
            } else {
              // Firebaseì— ë°ì´í„° ì—†ìœ¼ë©´ ë¡œì»¬ì—ì„œ ë¡œë“œ
              loadFromLocalStorage();
            }
            syncStudentsFromCourseData();
          })
          .catch(err => {
            console.error('Firebase ë¡œë“œ ì˜¤ë¥˜:', err);
            loadFromLocalStorage();
            syncStudentsFromCourseData();
          });
      } else {
        loadFromLocalStorage();
        syncStudentsFromCourseData();
      }
    }
    
    function loadFromLocalStorage() {
      const saved = localStorage.getItem(getStorageKey());
      if (saved) {
        attendanceData = JSON.parse(saved);
        // ë‚ ì§œ ë¬¸ìì—´ì„ Date ê°ì²´ë¡œ ë³€í™˜
        if (attendanceData.classStartTime) {
          attendanceData.classStartTime = new Date(attendanceData.classStartTime);
        }
        if (attendanceData.classEndTime) {
          attendanceData.classEndTime = new Date(attendanceData.classEndTime);
        }
      }
    }
    
    function syncStudentsFromCourseData() {
      // courseDataì—ì„œ ìˆ˜ê°•ìƒ ëª©ë¡ ë™ê¸°í™”
      const courseInfo = courseData.find(c => c.name === currentUser.course);
      if (courseInfo) {
        attendanceData.students = courseInfo.students || [];
        saveAttendanceDataLocal();
      }
    }

    // ========== ìˆ˜ê°•ìƒ ê´€ë¦¬ ==========
    
    function openStudentModal() {
      document.getElementById('studentModal').classList.add('show');
      renderStudentList();
    }

    function closeStudentModal() {
      document.getElementById('studentModal').classList.remove('show');
    }

    function handleStudentKeypress(e) {
      if (e.key === 'Enter') {
        addStudent();
      }
    }

    function addStudent() {
      const input = document.getElementById('newStudentName');
      const name = input.value.trim();
      
      if (!name) {
        alert('ìˆ˜ê°•ìƒ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      if (attendanceData.students.includes(name)) {
        alert('ì´ë¯¸ ë“±ë¡ëœ ìˆ˜ê°•ìƒì…ë‹ˆë‹¤.');
        return;
      }
      
      attendanceData.students.push(name);
      saveAttendanceDataLocal();
      renderStudentList();
      input.value = '';
      input.focus();
    }

    function removeStudent(name) {
      if (confirm(`"${name}" ìˆ˜ê°•ìƒì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        attendanceData.students = attendanceData.students.filter(s => s !== name);
        saveAttendanceDataLocal();
        renderStudentList();
      }
    }

    function renderStudentList() {
      const container = document.getElementById('studentList');
      
      if (attendanceData.students.length === 0) {
        container.innerHTML = '<div class="empty-list">ë“±ë¡ëœ ìˆ˜ê°•ìƒì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }
      
      container.innerHTML = attendanceData.students.map((name, index) => `
        <div class="student-item">
          <span class="student-name">${index + 1}. ${name}</span>
          <button class="delete-btn" onclick="removeStudent('${name}')">&times;</button>
        </div>
      `).join('');
    }

    // ========== ìˆ˜ì—… ì‹œì‘/ì¢…ë£Œ ==========
    
    function startClass() {
      if (attendanceData.students.length === 0) {
        alert('ìˆ˜ê°•ìƒì´ ë“±ë¡ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.\nìš´ì˜ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      const week = prompt('ëª‡ ì£¼ì°¨ ìˆ˜ì—…ì¸ê°€ìš”? (1-16)', attendanceData.currentWeek);
      if (!week) return;
      
      const weekNum = parseInt(week);
      if (isNaN(weekNum) || weekNum < 1 || weekNum > 16) {
        alert('1-16 ì‚¬ì´ì˜ ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      attendanceData.currentWeek = weekNum;
      attendanceData.classStartTime = new Date();
      attendanceData.classEndTime = null;
      attendanceData.isClassActive = true;
      
      // í•´ë‹¹ ì£¼ì°¨ ì¶œì„ ê¸°ë¡ ì´ˆê¸°í™”
      if (!attendanceData.records[weekNum]) {
        attendanceData.records[weekNum] = {};
      }
      
      // ëª¨ë“  í•™ìƒ ê²°ì„ìœ¼ë¡œ ì´ˆê¸°í™”
      attendanceData.students.forEach(name => {
        if (!attendanceData.records[weekNum][name]) {
          attendanceData.records[weekNum][name] = {
            joinTime: null,
            leaveTime: null,
            status: 'absent'
          };
        }
      });
      
      saveAttendanceDataLocal();
      updateClassUI();
      
      alert(`${weekNum}ì£¼ì°¨ ìˆ˜ì—…ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!\nì‹œì‘ ì‹œê°„: ${formatTime(attendanceData.classStartTime)}`);
    }

    function endClass() {
      if (!confirm('ìˆ˜ì—…ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      
      attendanceData.classEndTime = new Date();
      attendanceData.isClassActive = false;
      
      // ì¶œì„ ìƒíƒœ ìµœì¢… ê³„ì‚°
      calculateFinalAttendance();
      
      saveAttendanceDataLocal();
      updateClassUI();
      
      // ì¶œì„ ê²°ê³¼ í‘œì‹œ
      openAttendanceModal();
      alert(`ìˆ˜ì—…ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\nì¢…ë£Œ ì‹œê°„: ${formatTime(attendanceData.classEndTime)}`);
    }

    function calculateFinalAttendance() {
      const week = attendanceData.currentWeek;
      const records = attendanceData.records[week];
      const startTime = attendanceData.classStartTime;
      const endTime = attendanceData.classEndTime;
      const lateThreshold = 15 * 60 * 1000; // 15ë¶„ (ë°€ë¦¬ì´ˆ)
      
      attendanceData.students.forEach(name => {
        const record = records[name];
        if (!record) return;
        
        if (!record.joinTime) {
          // ì…ì¥ ê¸°ë¡ ì—†ìŒ = ê²°ì„
          record.status = 'absent';
        } else {
          const joinTime = new Date(record.joinTime);
          const leaveTime = record.leaveTime ? new Date(record.leaveTime) : endTime;
          const joinDelay = joinTime - startTime;
          
          if (leaveTime < endTime) {
            // ìˆ˜ì—… ì¢…ë£Œ ì „ì— ë‚˜ê° = ì¡°í‡´
            record.status = 'early-leave';
          } else if (joinDelay > lateThreshold) {
            // 15ë¶„ ì´í›„ ì…ì¥ = ì§€ê° (í•˜ì§€ë§Œ 15ë¶„ ì´í›„ë„ ì°¸ì—¬í–ˆìœ¼ë©´ ì§€ê° ì²˜ë¦¬)
            record.status = 'late';
          } else if (joinDelay > 0 && joinDelay <= lateThreshold) {
            // ìˆ˜ì—… ì‹œì‘ í›„ 15ë¶„ ì´ë‚´ ì…ì¥ = ì§€ê°
            record.status = 'late';
          } else {
            // ì •ìƒ ì¶œì„
            record.status = 'present';
          }
        }
      });
      
      saveAttendanceDataLocal();
    }

    function updateClassUI() {
      const btnStart = document.getElementById('btnStartClass');
      const btnEnd = document.getElementById('btnEndClass');
      const statusDot = document.getElementById('statusDot');
      const statusText = document.getElementById('classStatusText');
      
      if (attendanceData.isClassActive) {
        btnStart.disabled = true;
        btnEnd.disabled = false;
        statusDot.classList.add('live');
        statusText.textContent = `${attendanceData.currentWeek}ì£¼ì°¨ ìˆ˜ì—… ì§„í–‰ì¤‘`;
      } else {
        btnStart.disabled = false;
        btnEnd.disabled = true;
        statusDot.classList.remove('live');
        statusText.textContent = 'ìˆ˜ì—… ëŒ€ê¸°ì¤‘';
      }
    }

    // ========== í•™ìƒ ì…ì¥/í‡´ì¥ ê¸°ë¡ ==========
    
    function recordStudentJoin(studentName) {
      if (!attendanceData.isClassActive) return;
      
      const week = attendanceData.currentWeek;
      if (!attendanceData.records[week]) {
        attendanceData.records[week] = {};
      }
      
      if (!attendanceData.records[week][studentName]) {
        attendanceData.records[week][studentName] = {
          joinTime: null,
          leaveTime: null,
          status: 'absent'
        };
      }
      
      // ì²« ì…ì¥ ì‹œê°„ë§Œ ê¸°ë¡
      if (!attendanceData.records[week][studentName].joinTime) {
        attendanceData.records[week][studentName].joinTime = new Date();
      }
      
      saveAttendanceDataLocal();
    }

    function recordStudentLeave(studentName) {
      if (!attendanceData.isClassActive) return;
      
      const week = attendanceData.currentWeek;
      if (attendanceData.records[week] && attendanceData.records[week][studentName]) {
        attendanceData.records[week][studentName].leaveTime = new Date();
        saveAttendanceDataLocal();
      }
    }

    // ========== ì¶œì„ë¶€ í‘œì‹œ ==========
    
    function openAttendanceModal() {
      document.getElementById('attendanceModal').classList.add('show');
      document.getElementById('weekSelect').value = attendanceData.currentWeek;
      renderAttendanceTable();
    }

    function closeAttendanceModal() {
      document.getElementById('attendanceModal').classList.remove('show');
    }

    function renderAttendanceTable() {
      const week = parseInt(document.getElementById('weekSelect').value);
      const tbody = document.getElementById('attendanceTableBody');
      const records = attendanceData.records[week] || {};
      
      if (attendanceData.students.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#6b7280;padding:30px;">ë“±ë¡ëœ ìˆ˜ê°•ìƒì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        document.getElementById('attendanceSummary').innerHTML = '';
        return;
      }
      
      let presentCount = 0, lateCount = 0, earlyLeaveCount = 0, absentCount = 0;
      
      tbody.innerHTML = attendanceData.students.map((name, index) => {
        const record = records[name] || { joinTime: null, leaveTime: null, status: 'pending' };
        const status = record.status || 'pending';
        
        // ì¹´ìš´íŠ¸
        if (status === 'present') presentCount++;
        else if (status === 'late') lateCount++;
        else if (status === 'early-leave') earlyLeaveCount++;
        else if (status === 'absent') absentCount++;
        
        const statusLabel = {
          'present': 'ì¶œì„',
          'late': 'ì§€ê°',
          'early-leave': 'ì¡°í‡´',
          'absent': 'ê²°ì„',
          'pending': 'ë¯¸ì •'
        };
        
        return `
          <tr>
            <td>${index + 1}</td>
            <td>${name}</td>
            <td class="time-info">${record.joinTime ? formatTime(new Date(record.joinTime)) : '-'}</td>
            <td class="time-info">${record.leaveTime ? formatTime(new Date(record.leaveTime)) : '-'}</td>
            <td>
              <span class="attendance-status ${status}">${statusLabel[status]}</span>
            </td>
          </tr>
        `;
      }).join('');
      
      // ìš”ì•½ í‘œì‹œ
      document.getElementById('attendanceSummary').innerHTML = `
        <div class="summary-item">
          <span class="attendance-status present">ì¶œì„</span>
          <span class="count">${presentCount}ëª…</span>
        </div>
        <div class="summary-item">
          <span class="attendance-status late">ì§€ê°</span>
          <span class="count">${lateCount}ëª…</span>
        </div>
        <div class="summary-item">
          <span class="attendance-status early-leave">ì¡°í‡´</span>
          <span class="count">${earlyLeaveCount}ëª…</span>
        </div>
        <div class="summary-item">
          <span class="attendance-status absent">ê²°ì„</span>
          <span class="count">${absentCount}ëª…</span>
        </div>
        <div class="summary-item" style="margin-left:auto;">
          ì´ <span class="count">${attendanceData.students.length}ëª…</span>
        </div>
      `;
    }

    function exportAttendance() {
      const week = document.getElementById('weekSelect').value;
      const records = attendanceData.records[week] || {};
      
      let csv = 'ë²ˆí˜¸,ì´ë¦„,ì…ì¥ì‹œê°„,í‡´ì¥ì‹œê°„,ì¶œì„ìƒíƒœ\n';
      
      attendanceData.students.forEach((name, index) => {
        const record = records[name] || {};
        const statusLabel = {
          'present': 'ì¶œì„',
          'late': 'ì§€ê°',
          'early-leave': 'ì¡°í‡´',
          'absent': 'ê²°ì„',
          'pending': 'ë¯¸ì •'
        };
        
        csv += `${index + 1},${name},`;
        csv += `${record.joinTime ? formatTime(new Date(record.joinTime)) : '-'},`;
        csv += `${record.leaveTime ? formatTime(new Date(record.leaveTime)) : '-'},`;
        csv += `${statusLabel[record.status] || 'ë¯¸ì •'}\n`;
      });
      
      const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `ì¶œì„ë¶€_${currentUser.course}_${week}ì£¼ì°¨.csv`;
      link.click();
    }

    function formatTime(date) {
      if (!date) return '-';
      return date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }

    // ========== UI ì—…ë°ì´íŠ¸ (ì¶œì„ ê´€ë ¨) ==========
    // êµìˆ˜/í•™ìƒ ì»¨íŠ¸ë¡¤ì€ ì´ì œ í—¤ë”ì— í†µí•©ë˜ì–´ updateMainUI()ì—ì„œ ì²˜ë¦¬ë¨

    // í•™ìƒ ìë™ ì¶œì„ ì²´í¬
    function checkStudentAttendance() {
      // ê°•ì˜ ë°ì´í„° ë¡œë“œ
      const storageKey = `attendance_${currentUser.course}`;
      const saved = localStorage.getItem(storageKey);
      
      if (saved) {
        const data = JSON.parse(saved);
        if (data.isClassActive && data.students.includes(currentUser.name)) {
          // í•™ìƒì´ ìˆ˜ê°•ìƒ ëª©ë¡ì— ìˆê³  ìˆ˜ì—…ì´ ì§„í–‰ ì¤‘ì´ë©´ ì…ì¥ ê¸°ë¡
          if (!data.records[data.currentWeek]) {
            data.records[data.currentWeek] = {};
          }
          if (!data.records[data.currentWeek][currentUser.name]) {
            data.records[data.currentWeek][currentUser.name] = {
              joinTime: null,
              leaveTime: null,
              status: 'absent'
            };
          }
          if (!data.records[data.currentWeek][currentUser.name].joinTime) {
            data.records[data.currentWeek][currentUser.name].joinTime = new Date().toISOString();
            localStorage.setItem(storageKey, JSON.stringify(data));
            console.log('ì¶œì„ ì²´í¬ë¨:', currentUser.name);
          }
        }
      }
    }

    // í•™ìƒ í‡´ì¥ ì‹œ ê¸°ë¡ (í˜ì´ì§€ ë– ë‚  ë•Œ)
    window.addEventListener('beforeunload', () => {
      if (currentUser.role === 'student' && currentUser.course) {
        const storageKey = `attendance_${currentUser.course}`;
        const saved = localStorage.getItem(storageKey);
        
        if (saved) {
          const data = JSON.parse(saved);
          if (data.isClassActive && data.records[data.currentWeek] && 
              data.records[data.currentWeek][currentUser.name]) {
            const leaveTime = new Date().toISOString();
            data.records[data.currentWeek][currentUser.name].leaveTime = leaveTime;
            localStorage.setItem(storageKey, JSON.stringify(data));
            
            // Firebaseì—ë„ ì €ì¥ (ë™ê¸°ì ìœ¼ë¡œ ì‹œë„)
            if (firebaseEnabled && db) {
              const firebaseKey = currentUser.course.replace(/[.#$\/\[\]]/g, '_');
              const updatePath = `attendance/${firebaseKey}/records/${data.currentWeek}/${currentUser.name}/leaveTime`;
              db.ref(updatePath).set(leaveTime);
              console.log('ğŸ“¤ í‡´ì¥ì‹œê°„ Firebase ì €ì¥:', leaveTime);
            }
          }
        }
      }
    });
    
    // ì¶”ê°€: visibilitychange ì´ë²¤íŠ¸ë¡œ íƒ­ ìˆ¨ê¹€ ì‹œì—ë„ ê¸°ë¡
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'hidden' && currentUser.role === 'student' && currentUser.course) {
        const storageKey = `attendance_${currentUser.course}`;
        const saved = localStorage.getItem(storageKey);
        
        if (saved) {
          const data = JSON.parse(saved);
          if (data.isClassActive && data.records[data.currentWeek] && 
              data.records[data.currentWeek][currentUser.name]) {
            const leaveTime = new Date().toISOString();
            data.records[data.currentWeek][currentUser.name].leaveTime = leaveTime;
            localStorage.setItem(storageKey, JSON.stringify(data));
            
            // Firebaseì—ë„ ì €ì¥
            if (firebaseEnabled && db) {
              const firebaseKey = currentUser.course.replace(/[.#$\/\[\]]/g, '_');
              db.ref(`attendance/${firebaseKey}/records/${data.currentWeek}/${currentUser.name}/leaveTime`).set(leaveTime);
              console.log('ğŸ“¤ í‡´ì¥ì‹œê°„ Firebase ì €ì¥ (íƒ­ ìˆ¨ê¹€):', leaveTime);
            }
          }
        }
      }
    });

    // ========== í•™ìƒ ì¶œì„í˜„í™© ëª¨ë‹¬ ==========
    
    function openMyAttendanceModal() {
      document.getElementById('myAttendanceModal').classList.add('show');
      renderMyAttendance();
    }
    
    function closeMyAttendanceModal() {
      document.getElementById('myAttendanceModal').classList.remove('show');
    }
    
    async function renderMyAttendance() {
      document.getElementById('myCourseName').textContent = currentUser.course;
      
      // Firebase ë˜ëŠ” localStorageì—ì„œ ì¶œì„ ë°ì´í„° ë¡œë“œ
      const firebaseKey = currentUser.course.replace(/[.#$\/\[\]]/g, '_');
      let attendanceInfo = null;
      
      if (firebaseEnabled && db) {
        try {
          const snapshot = await db.ref(`attendance/${firebaseKey}`).once('value');
          attendanceInfo = snapshot.val();
        } catch (e) {
          console.error('Firebase ì¶œì„ ë¡œë“œ ì˜¤ë¥˜:', e);
        }
      }
      
      // Firebaseì— ì—†ìœ¼ë©´ localStorageì—ì„œ ë¡œë“œ
      if (!attendanceInfo) {
        const saved = localStorage.getItem(`attendance_${currentUser.course}`);
        if (saved) {
          attendanceInfo = JSON.parse(saved);
        }
      }
      
      const summaryEl = document.getElementById('myAttendanceSummary');
      const listEl = document.getElementById('myAttendanceList');
      
      console.log('ğŸ“‹ ì¶œì„ ë°ì´í„° ë¡œë“œë¨:', attendanceInfo);
      
      if (!attendanceInfo || !attendanceInfo.records) {
        console.log('âŒ ì¶œì„ recordsê°€ ì—†ìŒ');
        summaryEl.innerHTML = '';
        listEl.innerHTML = '<div style="text-align:center;padding:20px;color:#9ca3af;">ì¶œì„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }
      
      console.log('ğŸ“‹ records í‚¤:', Object.keys(attendanceInfo.records));
      console.log('ğŸ‘¤ í˜„ì¬ í•™ìƒ:', currentUser.name);
      
      // ë‚´ ì¶œì„ í†µê³„ ê³„ì‚°
      let present = 0, late = 0, absent = 0, earlyLeave = 0;
      const weekRecords = [];
      
      // ê°€ëŠ¥í•œ ì£¼ì°¨ í‚¤ í˜•ì‹ë“¤ í™•ì¸ ("1", "1ì£¼ì°¨", "week1" ë“±)
      const possibleWeekFormats = (week) => [`${week}`, `${week}ì£¼ì°¨`, `week${week}`];
      
      for (let week = 1; week <= 15; week++) {
        let record = null;
        let weekKey = null;
        
        // ì—¬ëŸ¬ í˜•ì‹ìœ¼ë¡œ ì‹œë„
        for (const format of possibleWeekFormats(week)) {
          if (attendanceInfo.records[format] && attendanceInfo.records[format][currentUser.name]) {
            record = attendanceInfo.records[format][currentUser.name];
            weekKey = `${week}ì£¼ì°¨`;
            break;
          }
        }
        
        if (record) {
          weekRecords.push({ week: weekKey, ...record });
          
          switch (record.status) {
            case 'present': present++; break;
            case 'late': late++; break;
            case 'early-leave': earlyLeave++; break;
            case 'absent': absent++; break;
          }
        }
      }
      
      // ìš”ì•½ í‘œì‹œ
      summaryEl.innerHTML = `
        <div style="padding:12px 16px;background:#064e3b;border-radius:8px;text-align:center;min-width:70px;">
          <div style="font-size:20px;font-weight:bold;color:#6ee7b7;">${present}</div>
          <div style="font-size:11px;color:#9ca3af;">ì¶œì„</div>
        </div>
        <div style="padding:12px 16px;background:#78350f;border-radius:8px;text-align:center;min-width:70px;">
          <div style="font-size:20px;font-weight:bold;color:#fcd34d;">${late}</div>
          <div style="font-size:11px;color:#9ca3af;">ì§€ê°</div>
        </div>
        <div style="padding:12px 16px;background:#1e3a5f;border-radius:8px;text-align:center;min-width:70px;">
          <div style="font-size:20px;font-weight:bold;color:#93c5fd;">${earlyLeave}</div>
          <div style="font-size:11px;color:#9ca3af;">ì¡°í‡´</div>
        </div>
        <div style="padding:12px 16px;background:#7f1d1d;border-radius:8px;text-align:center;min-width:70px;">
          <div style="font-size:20px;font-weight:bold;color:#fca5a5;">${absent}</div>
          <div style="font-size:11px;color:#9ca3af;">ê²°ì„</div>
        </div>
      `;
      
      // ì£¼ì°¨ë³„ ê¸°ë¡ í‘œì‹œ
      if (weekRecords.length === 0) {
        listEl.innerHTML = '<div style="text-align:center;padding:20px;color:#9ca3af;">ì¶œì„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
      } else {
        listEl.innerHTML = `
          <table style="width:100%;border-collapse:collapse;font-size:13px;">
            <thead>
              <tr style="border-bottom:1px solid #374151;">
                <th style="padding:10px;text-align:left;color:#9ca3af;">ì£¼ì°¨</th>
                <th style="padding:10px;text-align:center;color:#9ca3af;">ìƒíƒœ</th>
                <th style="padding:10px;text-align:center;color:#9ca3af;">ì…ì¥ì‹œê°„</th>
              </tr>
            </thead>
            <tbody>
              ${weekRecords.map(r => `
                <tr style="border-bottom:1px solid #1f2937;">
                  <td style="padding:10px;">${r.week}</td>
                  <td style="padding:10px;text-align:center;">
                    <span class="attendance-status ${r.status}">${getStatusText(r.status)}</span>
                  </td>
                  <td style="padding:10px;text-align:center;color:#9ca3af;">
                    ${r.joinTime ? new Date(r.joinTime).toLocaleTimeString('ko-KR') : '-'}
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      }
    }
    
    function getStatusText(status) {
      const statusMap = {
        'present': 'ì¶œì„',
        'late': 'ì§€ê°',
        'early-leave': 'ì¡°í‡´',
        'absent': 'ê²°ì„',
        'pending': 'ë¯¸ì •'
      };
      return statusMap[status] || status;
    }
    
    // í•™ìƒ ìˆ˜ë™ ì¶œì„í•˜ê¸° ë²„íŠ¼
    async function studentCheckIn() {
      const firebaseKey = currentUser.course.replace(/[.#$\/\[\]]/g, '_');
      let attendanceInfo = null;
      
      // Firebaseì—ì„œ ì¶œì„ ë°ì´í„° ë¡œë“œ
      if (firebaseEnabled && db) {
        try {
          const snapshot = await db.ref(`attendance/${firebaseKey}`).once('value');
          attendanceInfo = snapshot.val();
        } catch (e) {
          console.error('Firebase ì¶œì„ ë¡œë“œ ì˜¤ë¥˜:', e);
        }
      }
      
      // localStorageì—ì„œë„ í™•ì¸
      if (!attendanceInfo) {
        const saved = localStorage.getItem(`attendance_${currentUser.course}`);
        if (saved) {
          attendanceInfo = JSON.parse(saved);
        }
      }
      
      if (!attendanceInfo) {
        alert('ì¶œì„ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nêµìˆ˜ë‹˜ì´ ìˆ˜ì—…ì„ ì‹œì‘í•˜ë©´ ìë™ìœ¼ë¡œ ì¶œì„ë©ë‹ˆë‹¤.');
        return;
      }
      
      if (!attendanceInfo.isClassActive) {
        alert('í˜„ì¬ ìˆ˜ì—…ì´ ì§„í–‰ ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤.\nêµìˆ˜ë‹˜ì´ ìˆ˜ì—…ì„ ì‹œì‘í•˜ë©´ ì¶œì„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
      }
      
      const weekKey = attendanceInfo.currentWeek;
      if (!attendanceInfo.records) attendanceInfo.records = {};
      if (!attendanceInfo.records[weekKey]) attendanceInfo.records[weekKey] = {};
      
      if (attendanceInfo.records[weekKey][currentUser.name]?.joinTime) {
        alert('ì´ë¯¸ ì¶œì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
        return;
      }
      
      // ì¶œì„ ê¸°ë¡
      attendanceInfo.records[weekKey][currentUser.name] = {
        joinTime: new Date().toISOString(),
        leaveTime: null,
        status: 'present'
      };
      
      // Firebaseì— ì €ì¥
      if (firebaseEnabled && db) {
        try {
          await db.ref(`attendance/${firebaseKey}`).set(attendanceInfo);
          console.log('ğŸ“¤ ì¶œì„ Firebase ì €ì¥ ì™„ë£Œ');
        } catch (e) {
          console.error('Firebase ì €ì¥ ì˜¤ë¥˜:', e);
        }
      }
      
      // localStorageì—ë„ ì €ì¥
      localStorage.setItem(`attendance_${currentUser.course}`, JSON.stringify(attendanceInfo));
      
      alert('âœ… ì¶œì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
      
      // ì¶œì„í•˜ê¸° ë²„íŠ¼ ë¹„í™œì„±í™”
      const btnCheckIn = document.getElementById('btnCheckIn');
      if (btnCheckIn) {
        btnCheckIn.disabled = true;
        btnCheckIn.textContent = 'âœ… ì¶œì„ì™„ë£Œ';
      }
    }

    // ========== Firebase ì§„ë‹¨ ê¸°ëŠ¥ ==========
    
    async function checkFirebaseStatus() {
      let report = '===== Firebase ì§„ë‹¨ ê²°ê³¼ =====\n\n';
      
      // 1. Firebase ì—°ê²° ìƒíƒœ
      report += `1. Firebase í™œì„±í™”: ${firebaseEnabled ? 'âœ… ì˜ˆ' : 'âŒ ì•„ë‹ˆì˜¤'}\n`;
      report += `2. DB ê°ì²´: ${db ? 'âœ… ìˆìŒ' : 'âŒ ì—†ìŒ'}\n\n`;
      
      // 2. ê°•ì˜ ë°ì´í„° í™•ì¸
      report += '===== ê°•ì˜ ë°ì´í„° =====\n';
      report += `ë¡œì»¬ ê°•ì˜ ìˆ˜: ${courseData.length}ê°œ\n`;
      if (courseData.length > 0) {
        courseData.forEach(c => {
          report += `  - ${c.name} (êµìˆ˜: ${c.professor}, í•™ìƒ: ${c.students?.length || 0}ëª…)\n`;
        });
      }
      
      // 3. Firebaseì—ì„œ ì§ì ‘ ì½ê¸° í…ŒìŠ¤íŠ¸
      if (firebaseEnabled && db) {
        report += '\n===== Firebase ì§ì ‘ ì¡°íšŒ =====\n';
        
        try {
          // ê°•ì˜ ë°ì´í„°
          const coursesSnapshot = await db.ref('courses').once('value');
          const firebaseCourses = coursesSnapshot.val();
          if (firebaseCourses) {
            const courseList = Object.values(firebaseCourses);
            report += `Firebase ê°•ì˜ ìˆ˜: ${courseList.length}ê°œ\n`;
            courseList.forEach(c => {
              report += `  - ${c.name} (êµìˆ˜: ${c.professor}, í•™ìƒ: ${c.students?.length || 0}ëª…)\n`;
            });
          } else {
            report += 'Firebase ê°•ì˜: ì—†ìŒ (null)\n';
          }
          
          // ì¶œì„ ë°ì´í„°
          const attendanceSnapshot = await db.ref('attendance').once('value');
          const firebaseAttendance = attendanceSnapshot.val();
          report += `\nFirebase ì¶œì„ ë°ì´í„°:\n`;
          if (firebaseAttendance) {
            Object.keys(firebaseAttendance).forEach(key => {
              const att = firebaseAttendance[key];
              report += `  - ${key}: ìˆ˜ì—…ì¤‘=${att.isClassActive}, ì£¼ì°¨=${att.currentWeek || 'ì—†ìŒ'}\n`;
              if (att.records) {
                Object.keys(att.records).forEach(week => {
                  const weekData = att.records[week];
                  const studentCount = Object.keys(weekData).length;
                  report += `    ${week}: ${studentCount}ëª… ê¸°ë¡\n`;
                });
              }
            });
          } else {
            report += '  ì—†ìŒ (null)\n';
          }
          
          // í™œì„± ê°•ì˜ì‹¤
          const activeRoomsSnapshot = await db.ref('activeRooms').once('value');
          const activeRooms = activeRoomsSnapshot.val();
          report += `\nFirebase í™œì„± ê°•ì˜ì‹¤:\n`;
          if (activeRooms) {
            Object.keys(activeRooms).forEach(key => {
              const room = activeRooms[key];
              report += `  - ${key}: ì„œë²„=${room.server}, êµìˆ˜=${room.professor}\n`;
            });
          } else {
            report += '  ì—†ìŒ\n';
          }
          
        } catch (err) {
          report += `Firebase ì¡°íšŒ ì˜¤ë¥˜: ${err.message}\n`;
        }
      }
      
      // 4. localStorage í™•ì¸
      report += '\n===== localStorage ë°ì´í„° =====\n';
      const localCourses = localStorage.getItem('gcu_courses');
      report += `ë¡œì»¬ ê°•ì˜: ${localCourses ? JSON.parse(localCourses).length + 'ê°œ' : 'ì—†ìŒ'}\n`;
      
      // ì¶œì„ ë°ì´í„° í‚¤ í™•ì¸
      const attendanceKeys = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('attendance_')) {
          attendanceKeys.push(key);
        }
      }
      report += `ë¡œì»¬ ì¶œì„ ë°ì´í„°: ${attendanceKeys.length}ê°œ\n`;
      attendanceKeys.forEach(key => {
        const data = JSON.parse(localStorage.getItem(key));
        report += `  - ${key}: ìˆ˜ì—…ì¤‘=${data.isClassActive}, ì£¼ì°¨=${data.currentWeek || 'ì—†ìŒ'}\n`;
      });
      
      report += '\n===== ì§„ë‹¨ ì™„ë£Œ =====';
      
      console.log(report);
      alert(report);
    }
    
    // í…ŒìŠ¤íŠ¸ìš©: Firebaseì— ë°ì´í„° ì“°ê¸° í…ŒìŠ¤íŠ¸
    async function testFirebaseWrite() {
      if (!firebaseEnabled || !db) {
        alert('Firebaseê°€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        return;
      }
      
      const testData = {
        test: true,
        timestamp: Date.now(),
        message: 'Firebase ì“°ê¸° í…ŒìŠ¤íŠ¸'
      };
      
      try {
        await db.ref('_test').set(testData);
        alert('âœ… Firebase ì“°ê¸° ì„±ê³µ!\n\në°ì´í„°: ' + JSON.stringify(testData));
        
        // ë°”ë¡œ ì½ê¸° í…ŒìŠ¤íŠ¸
        const snapshot = await db.ref('_test').once('value');
        const readData = snapshot.val();
        console.log('ì½ê¸° í…ŒìŠ¤íŠ¸:', readData);
        
        // í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚­ì œ
        await db.ref('_test').remove();
      } catch (err) {
        alert('âŒ Firebase ì“°ê¸° ì‹¤íŒ¨!\n\nì˜¤ë¥˜: ' + err.message);
      }
    }

    // ========== PWA ì„¤ì¹˜ ê¸°ëŠ¥ ==========
    let deferredPrompt = null;

    // Service Worker ë“±ë¡
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then((registration) => {
            console.log('Service Worker ë“±ë¡ ì„±ê³µ:', registration.scope);
          })
          .catch((error) => {
            console.log('Service Worker ë“±ë¡ ì‹¤íŒ¨:', error);
          });
      });
    }

    // ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ ì´ë²¤íŠ¸ ìº¡ì²˜ (Android/Chrome/Edge)
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      
      // ì„¤ì¹˜ ë²„íŠ¼ í‘œì‹œ
      const installBtn = document.getElementById('installBtn');
      installBtn.classList.add('show');
    });

    // iOS ê°ì§€ ë° ê°€ì´ë“œ í‘œì‹œ
    function isIOS() {
      return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    }

    function isInStandaloneMode() {
      return window.matchMedia('(display-mode: standalone)').matches || 
             window.navigator.standalone === true;
    }

    // iOSì—ì„œ Safari ë¸Œë¼ìš°ì €ì¸ ê²½ìš° ê°€ì´ë“œ í‘œì‹œ
    if (isIOS() && !isInStandaloneMode()) {
      const iosGuide = document.getElementById('iosGuide');
      iosGuide.classList.add('show');
    }

    // ì•± ì„¤ì¹˜ í•¨ìˆ˜
    async function installApp() {
      if (!deferredPrompt) {
        alert('ì´ë¯¸ ì„¤ì¹˜ë˜ì—ˆê±°ë‚˜ ì„¤ì¹˜í•  ìˆ˜ ì—†ëŠ” í™˜ê²½ì…ë‹ˆë‹¤.');
        return;
      }

      // ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ í‘œì‹œ
      deferredPrompt.prompt();
      
      const { outcome } = await deferredPrompt.userChoice;
      console.log('ì„¤ì¹˜ ê²°ê³¼:', outcome);
      
      if (outcome === 'accepted') {
        document.getElementById('installBtn').classList.remove('show');
      }
      
      deferredPrompt = null;
    }

    // ì„¤ì¹˜ ì™„ë£Œ ì´ë²¤íŠ¸
    window.addEventListener('appinstalled', () => {
      console.log('ì•±ì´ ì„¤ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤!');
      document.getElementById('installBtn').classList.remove('show');
      deferredPrompt = null;
    });
  </script>
</body>
</html>
